# Claude と Obsidian の MCP 連携に関するトラブルシューティング議事録

## 1. 目的

-   Markdownエディタ「Obsidian」に蓄積したナレッジを、AIアシスタント「Claude Desktop App」から参照・活用できるようにする。
-   実現のために、Obsidianのコミュニティプラグイン `MCP Tools` を用いて両者を連携させる。

## 2. 最終的な状況

| 項目                 | 状況                                                                                                   | 詳細                                                                                                                                                                                            |
| :------------------- | :----------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **基本連携**         | <font color="green">**成功**</font>                                                                    | ClaudeからObsidian内のファイルを検索、読み取り、追記する基本機能は正常に動作。                                                                                                                    |
| **高度な連携**       | <font color="red">**課題あり**</font>                                                                   | `MCP Tools` が依存プラグインの `Smart Connections` を認識できず（設定画面で×印）、AIによる意味検索（セマンティック検索）が利用できない。プラグイン間の稀な相性問題または表示上のバグの可能性が高い。 |
| **作業PC環境**       | Windows                                                                                                |                                                                                                                                                                                                 |
| **Obsidian保管庫場所** | `G:\マイドライブ` (Google Drive)                                                                       | 当初これが問題の根本原因だったが、PC再起動などにより最終的にこの場所のまま動作に成功した。                                                                                                      |

---

## 3. 発生した問題と解決までの時系列ログ

### 問題1: `Smart Connections` が `MCP Tools` に認識されない
-   **状況**: `MCP Tools` の設定画面で、依存関係にある `Smart Connections` の項目が赤色の×印のままになる。
-   **試した対策**:
    1.  **プラグインの有効化確認**: `Smart Connections` は有効だった → 解決せず。
    2.  **プラグインの再有効化**: `MCP Tools` と `Smart Connections` を一度無効化し、`Smart Connections` → `MCP Tools` の順で有効化し直す → 解決せず。
    3.  **`Smart Connections` の初期化**: `Smart Connections` の設定画面で `Reload sources` を実行し、ノートのインデックスを作成。インデックス作成自体は成功したが、`MCP Tools` 側は認識しないまま → 解決せず。

---

### 問題2: `MCP Server` のインストールに失敗する (`EPERM` エラー)
-   **状況**: `MCP Tools` 設定画面で `Install server` をクリックすると、`EPERM: operation not permitted` というファイルアクセス権限エラーが発生する。
-   **原因分析**:
    -   Obsidianの開発者コンソール(`Ctrl+Shift+I`)を確認したところ、`mcp-server.exe` のインストールパスが **Googleドライブ(`G:\マイドライブ`)** の同期フォルダ内になっていた。
    -   Googleドライブの同期プロセスがファイルをロックし、`MCP Tools` によるサーバーファイルの書き込みを妨害していたことが根本原因と特定。
-   **試した対策**:
    1.  **保管庫のローカル移動を試みる**: 保管庫を `C:\Users\ユーザー名\OneDrive\Desktop` に移動。
    2.  しかし、移動先も **OneDrive** の同期対象だったため、同じ問題が再発。

> **【教訓】**
> Obsidianの保管庫は、**いかなるクラウド同期（Google Drive, OneDrive, Dropbox等）の影響も受けない、完全なローカルフォルダ（例: `C:\ObsidianVault`）**に配置することが、予期せぬファイルロック問題を避けるためのベストプラクティスである。

---

### 問題3: `MCP Server` 起動に失敗する (`EADDRINUSE` エラー)
-   **状況**: `EPERM`エラーが解消された後、今度は `EADDRINUSE: address already in use` というネットワークエラーが開発者コンソールに表示される。
-   **原因分析**:
    -   これは「住所（ポート番号）が既に使用中です」という意味。
    -   これまでのトラブルシューティング過程で異常終了した `mcp-server.exe` の**「ゴーストプロセス」**が、見えないところでポートを占有し続けていたことが原因。
-   **解決策**:
    -   **PCを再起動する。**
    -   再起動により、メモリ上の全てのゴーストプロセスが一掃され、ポートが解放された。

---

### 問題4: Claudeアプリ側が古い設定を参照していた
-   **状況**: PC再起動後も連携がうまくいかず。
-   **原因分析**:
    -   Claude Desktopアプリの設定画面（開発者 -> エクステンション）を確認したところ、連携サーバーのパスとして、問題のあった **Gドライブの古いパス** が登録されたままになっていた。
-   **解決策**:
    1.  Claudeの設定画面で、古い `obsidian-mcp-tools` の設定を**ゴミ箱アイコンで削除**。
    2.  ClaudeとObsidianを両方とも完全に終了。
    3.  Obsidianを先に起動し、`MCP Tools` の設定画面で `Uninstall` → `Install server` を実行。
    4.  これにより、Claude側に正しいパスを持つ新しい設定が自動的に再作成された。

---

## 4. 総括と今後の推奨事項

本件は、複数の問題が連鎖的に発生した複合的なトラブルシューティングであった。

1.  **基本連携の成功**: 上記の問題をすべて解決した結果、ClaudeからObsidianのファイルを読み書きする基本的な連携が成功した。
2.  **クラウド同期の危険性**: トラブルの大部分は、**保管庫をクラウド同期フォルダに置いていたこと**に起因する。今後の安定運用のためには、完全なローカルフォルダへの移行を推奨する。
3.  **`Smart Connections`の未認識問題**: 全ての問題を解決してもなお、`Smart Connections`が認識されない問題は残存した。これはプラグイン間の稀な相性問題の可能性が高く、現時点では「基本的な連携はできるが、高度な検索はできない状態」として運用を開始するのが現実的である。
4.  **トラブルシューティングの要点**:
    -   原因不明のエラー時は、まず**開発者コンソール(`Ctrl+Shift+I`)**でエラーログを確認することが最も重要。
    -   ファイルアクセス系のエラーは、**クラウド同期**を第一に疑う。
    -   ネットワーク系のエラー（`EADDRINUSE`）は、**PC再起動**が最も確実な解決策。 