# Cursor & Claude Code ターミナル版 連携設定：完全対応議事録

## 1. 最終目的

当初の目的は、CursorエディタのUI上に表示されるアイコンから`Claude Code`のAIチャット機能を手軽に利用することであった。しかし、対話とトラブルシューティングを重ねる中で、`Claude Code`には2つの主要な製品が存在することが判明した。

1.  **GUI拡張機能版**: VS Codeマーケットプレースからインストールする、手軽なAIチャットパネル。
2.  **ターミナルCLI版**: コマンドラインで対話し、より高度で自律的な開発作業を行える専門家ツール。

最終的に、よりパワフルで多機能な**「2. ターミナルCLI版」**を安定して利用できる環境を構築することを最終ゴールとした。

---

## 2. トラブルシューティングの全行程

問題解決に至るまで、複雑に絡み合った複数の原因を特定し、段階的に解決する必要があった。以下にその全行程を記録する。

### Phase 1: Windowsへの直接インストールと最初の壁

-   **事象**: `npm install`コマンドがPowerShellで失敗。
-   **原因**:
    1.  PCにNode.js/npmが未インストールだった。
    2.  Node.jsインストール後も、`Claude Code is not supported on Windows`というエラーが発生。
-   **判明した事実**: `Claude Code` CLI版はWindowsにネイティブ対応しておらず、**Linux環境が必須**である。
-   **対策**: Windows上でLinux環境を構築できる**WSL (Windows Subsystem for Linux)**を導入する方針に転換。

### Phase 2: WSL環境の構築とCLI版のインストール

-   **事象**: WSLの導入後、WSL内のLinux (Ubuntu) 環境に`claude`をインストール。
-   **原因**: 新しく作成したUbuntu環境には、開発ツール(Node.js/npm)がなかった。
-   **対策**:
    1.  `nvm` (Node Version Manager) を利用して、安全にNode.jsとnpmをインストール。
    2.  `npm install -g @anthropic-ai/claude-code` を実行し、CLI版のインストールに成功。

### Phase 3: 「見えない壁」との戦い - 連携の失敗

CLI版のインストールには成功したものの、`claude`はCursorと全く連携できず、アイコンも表示されなかった。ここからが本当の戦いの始まりであった。

| 発生した問題 | 根本原因 | 最終的な対策 |
| :--- | :--- | :--- |
| **1. PowerShellからの呼び出し失敗** | PowerShellからWSLを呼び出す際、`claude`コマンドの場所を見つけられなかった。 | **PowerShellプロファイル**に関数を定義し、`wsl.exe -ic`オプションで環境変数を強制的に読み込ませることで一時的に解決。 |
| **2. `cursor.exe`が見つからない** | `claude`が連携相手である`Cursor.exe`を見つけられなかった。原因は、**Windowsの環境変数PATHがWSLに引き継がれていなかった**ため。 | **`/etc/wsl.conf`**ファイルに`appendWindowsPath = true`を追記し、WSLがWindowsのコマンドを探せるようにした。 |
| **3. それでも`cursor.exe`が見つからない** | 上記対策後も連携に失敗。原因は、**壊れたCondaの初期化設定**が`~/.bashrc`に残り、我々のPATH設定を上書きしてしまっていたため。 | **`~/.bashrc`を編集**し、`conda initialize`ブロック全体をコメントアウトして無力化した。 |
| **4. 大文字・小文字の壁** | 上記対策後も連携に失敗。原因は、Linuxがファイル名の**大文字と小文字を厳密に区別する**ため、`claude`(小文字)が`Cursor.exe`(大文字)を見つけられなかった。 | `ln -s`コマンドを使い、`Cursor.exe`を指し示す**`cursor`(小文字)のシンボリックリンク（ショートカット）を作成**した。 |

### Phase 4: 「記憶喪失」問題と最終解決策

-   **事象**: 上記の全ての対策を講じても、`claude`は「私にはGUIに接続する能力はない」と応答。
-   **根本原因**: Cursorが起動する際、ターミナルに「君は私（Cursor）の中で動いている」という証明書（特殊な環境変数）を渡す。しかし、Windows上のCursorとWSL内の`claude`の間にはOSの壁があり、この**証明書が失われていた**。`claude`は自分がどこで実行されているか分からない「記憶喪失」状態に陥っていた。
-   **最終解決策**: Microsoftがこの問題のために提供している公式の**「WSL」拡張機能**をCursorにインストール。これにより、Cursor自体がWSL環境に直接接続する「一体化モード」で動作するようになり、証明書が失われることなく`claude`に届くようになった。

---

## 3. 現在の安定した環境と正しい使い方

長いトラブルシューティングの結果、以下のモダンで安定した開発環境が構築された。

### 環境構成
1.  **基本アーキテクチャ**: Cursorが**「WSL」拡張機能**を介して、WSL/Ubuntu環境に直接接続して動作する。
2.  **デフォルトターミナル**: Cursor内で開かれるターミナルは、**WSL/Ubuntuの`bash`シェル**がデフォルトとなっている。
3.  **`claude`本体**: WSL/Ubuntu環境内に、`npm`経由でインストールされている。

### 正しい利用手順
1.  **Cursorを起動する。**
    *   自動的に「WSL: Ubuntu」モードで接続される（ウィンドウ左下に緑色で表示）。

2.  **ターミナルを開き、プロジェクトフォルダへ移動する。**
    *   `cd`コマンドを使い、分析したいプロジェクトのルートフォルダに移動する。（例: `cd 鑑定本舗様サイト作成`）

3.  **ショートカットキーで`claude`を呼び出す。**
    *   **ターミナルで`claude`と入力する必要はない。**
    *   以前設定した**キーボードショートカット**（例: `Ctrl + Alt + C`）を押す。
    *   これにより、Cursorの画面上に`claude`のGUIインターフェイスが表示される。

---

## 4. 総括と学び

今回の長い道のりは、単なる`claude`のインストール作業ではなく、現代的なクロスプラットフォーム開発環境における、OS間の複雑な相互作用を解き明かすプロセスであった。

-   **`claude`製品の理解**: GUI拡張機能版と、専門的なターミナルCLI版は全くの別物である。
-   **WSLの壁**: WindowsとWSL間の連携には、PATH、環境変数、ファイルシステムの違いなど、複数の「見えない壁」が存在する。
-   **環境の汚染**: 過去のインストール（特にConda）が残した設定の残骸が、後々のトラブルの根源となりうる。
-   **公式の「橋」の重要性**: OS間の問題を解決するには、小手先の修正ではなく、公式に提供されている連携ツール（「WSL」拡張機能）が最も確実な解決策である。

この記録が、今後のチーム内での情報共有や、同様の問題に直面した際の貴重な道しるべとなることを願う。 