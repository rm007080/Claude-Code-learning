# セッションの管理

## はじめに

Claude Codeの「セッション」とは、起動してから終了するまでの一連の対話のことです。適切にセッションを管理することで、作業効率が大幅に向上します。この章では、セッションの継続、リセット、履歴管理の方法を詳しく解説します。

## セッションとは

### セッションの基本概念

**セッション**
- Claude Codeを起動してから終了するまでの対話
- 会話履歴、コンテキスト、設定を保持
- ファイルシステムのように自動保存される

**セッションに含まれる情報**
- 会話履歴（メッセージのやり取り）
- 作業ディレクトリ
- 使用したファイルの情報
- コンテキストウィンドウの内容
- モデルの選択設定

**セッションに含まれない情報**
- CLAUDE.md（別ファイルとして保存）
- 実際のファイル変更（Git管理）
- グローバル設定

### セッションのライフサイクル

```
起動 → 作業 → 終了 → 保存
  ↑              │
  └─ 再開 ←───────┘
```

1. **起動**: `claude` で新規セッション開始
2. **作業**: 対話しながら開発
3. **終了**: `Ctrl+C` または `/exit`
4. **保存**: セッション情報が自動保存される
5. **再開**: `claude --continue` または `claude --resume`

## セッションの開始方法

### 1. 新規セッション

**コマンド**

```bash
claude
```

**動作**
- 完全に新しいセッションが始まる
- 会話履歴は空
- 現在のディレクトリで作業
- CLAUDE.mdがあれば自動読み込み

**いつ使うか**
- 全く新しいタスクを始めるとき
- 前のセッションと無関係な作業
- クリーンな状態から始めたいとき

**例**

```bash
$ cd ~/projects/new-project
$ claude

╭────────────────────────────────────────────────────────────────╮
│ ✻ Welcome to Claude Code!                                      │
│                                                                │
│   cwd: /Users/username/projects/new-project                   │
╰────────────────────────────────────────────────────────────────╯

> /init  # まずプロジェクトを初期化
> Reactプロジェクトのセットアップをしてください
```

### 2. 直前のセッションを継続

**コマンド**

```bash
claude --continue
```

**短縮形**

```bash
claude -c
```

**動作**
- 最後に終了したセッションを復元
- 会話履歴が完全に保持される
- 同じ作業ディレクトリで再開
- モデル設定も保持

**いつ使うか**
- 休憩から戻ってきたとき
- 前日の作業の続き
- エラーで終了してしまったとき
- 昼休みの後

**例**

```bash
# 昨日の夕方
$ claude
> ユーザー認証機能を実装中...
# 作業終了
[Ctrl+C] [Ctrl+C]

# 翌朝
$ claude --continue

╭────────────────────────────────────────────────────────────────╮
│ ✻ Resuming session from 12 hours ago                          │
│   Last message: "JWTの実装が完了しました"                         │
│   Working on: User authentication                             │
╰────────────────────────────────────────────────────────────────╯

> 昨日の続きから、テストを追加してください
# スムーズに続きから再開
```

### 3. 過去のセッションから選択

**コマンド**

```bash
claude --resume
```

**短縮形**

```bash
claude -r
```

**動作**
- 過去のセッション一覧が表示される
- 好きなセッションを選んで再開
- 複数のタスクを並行管理できる

**表示される一覧**

```
    Modified    Created     # Messages Git Branch     Summary
❯ 1. 1m ago      12m ago              8 -              Simple HTML File Creation Assistance
  2. 31m ago     35m ago              5 -              Tailwind CSS Layout Design
  3. 2h ago      3h ago              15 main           User Authentication Implementation
  4. 1d ago      1d ago              42 feature/api    REST API Development
  5. 3d ago      3d ago              23 develop        Bug Fix: Pagination Issue
  6. 1w ago      1w ago              67 refactor       TypeScript Migration
```

**列の意味**
- **Modified**: 最後に更新した時刻
- **Created**: セッション作成時刻
- **# Messages**: 会話のメッセージ数
- **Git Branch**: 作業していたブランチ
- **Summary**: セッションの内容（自動生成）

**操作方法**
- **十字キー（↑↓）**: 選択を移動
- **Enter**: 選択したセッションを再開
- **Esc**: キャンセル（新規セッション開始）
- **数字キー**: 番号で直接選択

**例**

```bash
$ claude --resume

# 一覧から選択
# 3. User Authentication Implementation を選択

╭────────────────────────────────────────────────────────────────╮
│ ✻ Resuming session from 2 hours ago                           │
│   Working on: User Authentication Implementation              │
│   Files modified: 5                                           │
│   Last commit: Added login endpoint                           │
╰────────────────────────────────────────────────────────────────╯

> この機能のテストを追加してください
# 認証機能の作業に戻る
```

## セッションの終了方法

### 1. 正常終了（推奨）

**方法1: Ctrl+C × 2**

```bash
[Ctrl+C]
Really exit? Press Ctrl+C again to confirm, or any other key to cancel.

[Ctrl+C]
Saving session...
Goodbye!
$
```

**方法2: /exit コマンド**

```bash
> /exit

Saving session...
Goodbye!
$
```

どちらの方法でも、セッション情報が自動保存されます。

### 2. 強制終了（非推奨）

**ターミナルを閉じる**

ターミナルウィンドウを直接閉じても、セッションは保存されます。ただし、正常終了の方が安全です。

## セッションのリセット

### /clear - 会話履歴をクリア

**完全リセット（最も一般的）**

```bash
> /clear
```

**動作**
- 現在の会話履歴を削除
- コンテキストウィンドウを空にする
- CLAUDE.mdは保持される
- 作業ディレクトリはそのまま

**いつ使うか**

**1. タスクが変わったとき**

```bash
# 認証機能の実装完了
> /clear

# 次: ダッシュボード実装
> ダッシュボードを作成してください
```

**2. Claude Codeが混乱しているとき**

```bash
# 的外れな提案が続く
> /clear

# リセットして再度指示
> もう一度、明確に指示します...
```

**3. 長時間の作業後**

```bash
# 100メッセージ以上の会話
> /clear

# トークン節約と精度向上
```

### /compact - 会話を圧縮

**部分的リセット**

```bash
> /compact
```

**動作**
- 会話を要約して圧縮
- 重要な情報は保持
- トークン使用量を削減

**/clearとの違い**

| 項目 | /clear | /compact |
|------|--------|----------|
| 会話履歴 | 完全削除 | 要約して保持 |
| コンテキスト | リセット | 主要部分は保持 |
| 使用場面 | タスク切り替え | 同じタスクの継続 |
| トークン削減 | 最大 | 中程度 |

**いつ使うか**

```bash
# 50メッセージの長い会話
> /compact

Compressing conversation...
Before: 50 messages, ~15,000 tokens
After:  5 messages, ~2,500 tokens

# 重要な情報を保持したまま圧縮される
```

## セッション管理のベストプラクティス

### パターン1: 日常的な開発フロー

**朝の開始**

```bash
# 前日の続きから
$ claude --continue

> /status  # 状態確認
> 昨日の続きから始めます
```

**タスク切り替え**

```bash
# 認証機能 → ダッシュボード
> /clear
> 次のタスク: ダッシュボードを実装してください
```

**会話が長くなったら**

```bash
> /compact
# 30-40メッセージごとに実行
```

**終業時**

```bash
> 今日はここまでにします

[Ctrl+C] [Ctrl+C]
# セッション保存
```

### パターン2: 複数プロジェクトの並行作業

**プロジェクトAで作業**

```bash
$ cd ~/projects/project-a
$ claude
> 機能Aを実装...
[Ctrl+C] [Ctrl+C]
```

**プロジェクトBで作業**

```bash
$ cd ~/projects/project-b
$ claude
> 機能Bを実装...
[Ctrl+C] [Ctrl+C]
```

**プロジェクトAに戻る**

```bash
$ cd ~/projects/project-a
$ claude --resume
# プロジェクトAのセッションを選択
```

### パターン3: 実験とロールバック

**実験的な変更**

```bash
# まず、現在の状態をコミット
> git statusを確認してください
> 問題なければコミットしてください

# 実験開始
> 新しいアプローチを試してください
```

**失敗した場合**

```bash
# Git でロールバック
> git reset --hard HEAD

# セッションもリセット
> /clear

# 別のアプローチ
> 別の方法で実装してください
```

### パターン4: 長時間のデバッグセッション

**定期的な圧縮**

```bash
# バグ調査開始
> このバグの原因を調査してください

# 30分後
> /compact

# さらに調査
> 次はXXXを確認してください

# また30分後
> /compact
```

**重要な発見をメモ**

```bash
> 重要な発見: 原因はXXXでした
> これをdebug-notes.mdに記録してください

# セッションがリセットされても情報が残る
```

## セッションの保存場所

セッション情報は以下に保存されます:

```bash
~/.claude/sessions/
├── session-2024-11-13-001.json
├── session-2024-11-13-002.json
├── session-2024-11-12-001.json
└── ...
```

**注意**
- このファイルを直接編集しないでください
- 削除するとセッションが失われます
- バックアップしたい場合は、このディレクトリをコピー

## セッション履歴の管理

### 古いセッションの削除

自動的には削除されませんが、手動で削除できます:

```bash
# 30日以上前のセッションを削除
find ~/.claude/sessions/ -name "*.json" -mtime +30 -delete
```

### セッションのバックアップ

```bash
# セッションをバックアップ
cp -r ~/.claude/sessions/ ~/backups/claude-sessions-$(date +%Y%m%d)
```

### セッションの復元

```bash
# バックアップから復元
cp -r ~/backups/claude-sessions-20241113/ ~/.claude/sessions/
```

## トラブルシューティング

### セッションが見つからない

**問題**

```bash
$ claude --resume
No previous sessions found.
```

**原因と対処**
- セッションディレクトリが空
- ファイルが削除された
- 初回起動

**解決方法**

```bash
# 新規セッションを開始
$ claude
```

### セッションが破損している

**問題**

```bash
$ claude --continue
Error: Failed to load session
```

**解決方法**

```bash
# セッションファイルを削除
rm ~/.claude/sessions/session-2024-11-13-*.json

# 新規セッション開始
$ claude
```

### 複数のセッションを間違えた

**問題**

プロジェクトAで作業中に、誤ってプロジェクトBのセッションを再開してしまった。

**解決方法**

```bash
# すぐに終了
[Ctrl+C] [Ctrl+C]

# 正しいディレクトリに移動
$ cd ~/projects/project-a

# 改めて再開
$ claude --resume
# プロジェクトAのセッションを選択
```

## 高度なセッション管理

### セッションにタグ付け（擬似的）

セッション名を工夫することで、後から見つけやすくなります:

```bash
# セッション開始時に明確な目的を伝える
> このセッションでは、ユーザー認証機能を実装します

# こうすることで、Summaryが明確になる
```

### プロジェクトごとのセッション整理

```bash
# プロジェクトフォルダごとに作業
$ cd ~/projects/project-a
$ claude
# project-aのセッション

$ cd ~/projects/project-b
$ claude
# project-bのセッション

# resumeで選択しやすい
```

## まとめ

セッション管理の要点:

**セッションの開始**
- `claude`: 新規
- `claude --continue`: 直前の継続
- `claude --resume`: 過去から選択

**セッションのリセット**
- `/clear`: 完全リセット（タスク切り替え）
- `/compact`: 圧縮（同じタスクの継続）

**終了方法**
- `Ctrl+C × 2`: 推奨
- `/exit`: コマンド

**ベストプラクティス**
- タスク切り替えは `/clear`
- 定期的に `/compact`（30-40メッセージごと）
- 重要な情報はファイルに記録
- 作業前に `git commit`

**日常フロー**

```
朝: claude --continue
タスク切り替え: /clear
会話が長い: /compact
終業: Ctrl+C × 2
```

これで第1部「基礎編」の第1章〜第3章の全15ファイルが完成しました！

Claude Codeの基礎から、インストール、基本操作まで、初学者が段階的に学べる構成になっています。
