# トラブルシューティング - よくあるエラーと解決方法

## はじめに

Claude Codeを使い始める際、いくつかの一般的なエラーに遭遇することがあります。この章では、よく報告される問題とその解決方法を詳しく解説します。問題が発生したときは、このページを参照して段階的に解決していきましょう。

## インストール関連のエラー

### エラー1: `command not found: claude`

**症状**

```bash
$ claude
bash: claude: command not found
```

または

```powershell
PS> claude
'claude' は、内部コマンドまたは外部コマンド、
操作可能なプログラムまたはバッチ ファイルとして認識されていません。
```

**原因**
- Claude Codeがインストールされていない
- パスが通っていない
- npmのグローバルbinディレクトリがPATHに含まれていない

**解決方法1: インストール確認**

```bash
npm list -g @anthropic-ai/claude-code
```

何も表示されない場合は、インストールされていません:

```bash
npm install -g @anthropic-ai/claude-code
```

**解決方法2: パスの確認と追加（macOS/Linux/WSL）**

```bash
# npmのグローバルbinディレクトリを確認
npm config get prefix

# 表示された結果（例: /usr/local）を使ってパスを追加
echo 'export PATH="$PATH:/usr/local/bin"' >> ~/.bashrc
source ~/.bashrc
```

zshの場合:

```bash
echo 'export PATH="$PATH:/usr/local/bin"' >> ~/.zshrc
source ~/.zshrc
```

**解決方法3: パスの確認と追加（Windows）**

PowerShellで:

```powershell
# npm のグローバルパスを確認
npm config get prefix

# 例: C:\Users\username\AppData\Roaming\npm
# この path を環境変数に追加
```

システム環境変数にパスを追加:
1. 「システムのプロパティ」→「環境変数」
2. ユーザー環境変数の「Path」を編集
3. `C:\Users\username\AppData\Roaming\npm`を追加
4. PowerShellを再起動

### エラー2: `npm: command not found`

**症状**

```bash
$ npm install -g @anthropic-ai/claude-code
bash: npm: command not found
```

**原因**
- Node.jsがインストールされていない
- Node.jsのパスが通っていない

**解決方法: Node.jsのインストール**

**macOS（Homebrew使用）**

```bash
brew install node
```

**Windows**

1. [https://nodejs.org/](https://nodejs.org/) からインストーラーをダウンロード
2. LTS版をインストール
3. インストール後、PowerShellを再起動

**Linux（Ubuntu/Debian）**

```bash
# nvmを使った方法（推奨）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.bashrc
nvm install --lts

# または apt を使った方法
sudo apt update
sudo apt install nodejs npm
```

インストール後、確認:

```bash
node --version
npm --version
```

### エラー3: `EACCES: permission denied`

**症状**

```bash
$ npm install -g @anthropic-ai/claude-code
npm ERR! Error: EACCES: permission denied, access '/usr/local/lib/node_modules'
```

**原因**
- グローバルインストールの権限がない

**解決方法1: npmのグローバルディレクトリを変更（推奨）**

```bash
# ホームディレクトリにグローバルディレクトリを作成
mkdir -p ~/.npm-global

# npmの設定を変更
npm config set prefix '~/.npm-global'

# パスを追加
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# zshの場合
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.zshrc
source ~/.zshrc

# 再度インストール
npm install -g @anthropic-ai/claude-code
```

**解決方法2: sudoを使う（非推奨）**

```bash
sudo npm install -g @anthropic-ai/claude-code
```

**Note**: sudoを使うと権限の問題が複雑になるため、解決方法1を推奨します。

## 認証関連のエラー

### エラー4: `Authentication failed`

**症状**

```
╭──────────────────────────────────────────────╮
│ ✗ Authentication failed                      │
│   Please check your credentials and try again│
╰──────────────────────────────────────────────╯
```

**原因**
- 認証情報が間違っている
- 認証トークンが期限切れ
- APIキーが無効

**解決方法: 認証情報のリセット**

```bash
# 既存の認証情報を削除
rm ~/.claude/credentials.json

# Claude Codeを再起動
claude

# 認証フローをやり直す
```

**OAuth Token認証の場合**
- ブラウザで正しくログインできているか確認
- Claude.aiのProまたはMaxプランが有効か確認

**API Key認証の場合**
- APIキーが正しくコピーされているか確認
- Anthropic Consoleでキーが有効か確認
- 支払い方法が登録されているか確認

### エラー5: ブラウザが自動で開かない

**症状**

OAuth Token認証時、ブラウザが自動で開かず、認証ができない。

**原因**
- デフォルトブラウザが設定されていない
- WSL環境でブラウザへのアクセスができない

**解決方法1: URLを手動でコピー**

Claude Code起動時に表示されるURLをコピーして、手動でブラウザで開きます:

```bash
$ claude

Please visit the following URL to authenticate:
https://claude.ai/auth?token=XXXXX

# このURLをコピーしてブラウザに貼り付け
```

**解決方法2: API Key認証を使う**

OAuth Tokenの代わりにAPI Key認証を使用:

```bash
# 認証情報を削除
rm ~/.claude/credentials.json

# 再起動して API Key を選択
claude
# → 2. Anthropic Console (API key) を選択
```

**解決方法3: WSL環境の場合**

WSL用のブラウザ起動設定:

```bash
# wsl.confに設定を追加（Windows側）
# C:\Users\username\.wslconfig
[wsl2]
localhostForwarding=true
```

WSLを再起動:

```powershell
# PowerShellで実行
wsl --shutdown
wsl
```

### エラー6: `Invalid API key`

**症状**

```
╭──────────────────────────────────────────────╮
│ ✗ Invalid API key                            │
│   Please check your API key and try again    │
╰──────────────────────────────────────────────╯
```

**原因**
- APIキーが間違っている
- APIキーが無効化された
- APIキーの権限が不足

**解決方法**

1. Anthropic Consoleで新しいAPIキーを生成:
   - [https://console.anthropic.com/](https://console.anthropic.com/)
   - 左メニュー → API Keys
   - Create Key

2. 新しいキーで認証:
   ```bash
   rm ~/.claude/credentials.json
   claude
   # API Keyを選択して、新しいキーを入力
   ```

3. 環境変数を使っている場合は更新:
   ```bash
   export ANTHROPIC_API_KEY="sk-ant-api03-NEW-KEY-HERE"
   ```

## ネットワーク関連のエラー

### エラー7: `Network error` / `Connection timeout`

**症状**

```
╭──────────────────────────────────────────────╮
│ ✗ Network error                              │
│   Could not connect to Anthropic API         │
╰──────────────────────────────────────────────╯
```

**原因**
- インターネット接続の問題
- ファイアウォールがブロック
- プロキシ設定が必要

**解決方法1: インターネット接続の確認**

```bash
# Anthropic APIへの接続を確認
curl https://api.anthropic.com

# 応答があればネットワークは正常
```

**解決方法2: ファイアウォールの確認**

以下のドメインへのアクセスが許可されているか確認:
- `*.anthropic.com`
- `api.anthropic.com`
- `claude.ai`

企業ネットワークの場合、ネットワーク管理者に確認してください。

**解決方法3: プロキシ設定（企業ネットワーク）**

```bash
# HTTP プロキシの設定
export HTTP_PROXY=http://proxy.company.com:8080
export HTTPS_PROXY=http://proxy.company.com:8080

# npm のプロキシ設定
npm config set proxy http://proxy.company.com:8080
npm config set https-proxy http://proxy.company.com:8080

# Claude Code を起動
claude
```

**解決方法4: VPN接続の確認**

VPNを使用している場合、一時的に無効化して試してみてください。

### エラー8: `Rate limit exceeded`

**症状**

```
╭──────────────────────────────────────────────╮
│ ✗ Rate limit exceeded                        │
│   Please wait a moment and try again         │
╰──────────────────────────────────────────────╯
```

**原因**
- 短時間に大量のリクエストを送信
- API使用量の上限に達した

**解決方法**

1. 数分待ってから再試行

2. /modelでSonnetに切り替え（より制限が緩い）:
   ```bash
   > /model
   # Sonnet を選択
   ```

3. /compactで会話を圧縮してトークン節約:
   ```bash
   > /compact
   ```

4. 新しいセッションを開始:
   ```bash
   > /clear
   ```

5. API Key使用の場合、Anthropic Consoleで使用量を確認:
   - [https://console.anthropic.com/](https://console.anthropic.com/)
   - Usage → 使用量確認

## 動作関連のエラー

### エラー9: Claude Codeが固まる / 応答しない

**症状**

コマンドを実行しても、長時間応答がない。

**原因**
- ネットワークの問題
- 処理が重い
- セッションがクラッシュ

**解決方法1: Escで中断**

```bash
# Escキーを押して処理を中断
[Esc]

  ⎿  Interrupted by user
```

**解決方法2: 強制終了と再起動**

```bash
# Ctrl+C を2回押して強制終了
[Ctrl+C] [Ctrl+C]

# 再度起動
claude

# 前回の続きから再開したい場合
claude --continue
```

**解決方法3: /compactで会話をリセット**

会話が長くなりすぎた場合:

```bash
> /compact
# または
> /clear
```

### エラー10: ファイル編集の許可を求められ続ける

**症状**

毎回ファイル編集時に許可を求められて、作業が中断される。

**原因**
- 権限設定がデフォルト（都度確認）のまま

**解決方法1: セッション内で「Always allow」を選択**

ファイル編集の確認画面で:

```
Do you want to make this edit to index.html?
❯ 1. Yes
  2. Yes, and don't ask again this session (shift+tab)
  3. No, and tell Claude what to do differently (esc)
```

**2番**を選択すると、このセッション中は自動承認されます。

**解決方法2: settings.jsonで自動承認を設定**

`.claude/settings.json`を作成:

```json
{
  "permissions": {
    "allow": [
      "Write(*)"
    ]
  }
}
```

**Note**: 全てのファイル編集を自動承認するのはリスクがあります。慣れてから設定してください。

### エラー11: 日本語が文字化けする

**症状**

日本語のファイルやメッセージが文字化けして表示される。

**原因**
- ターミナルの文字コード設定が UTF-8 でない

**解決方法（Windows）**

PowerShellの文字コードを UTF-8 に設定:

```powershell
# PowerShell プロファイルに追加
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::InputEncoding = [System.Text.Encoding]::UTF8
```

または、PowerShellの設定:

1. `code $PROFILE` でプロファイルを開く
2. 以下を追加:

```powershell
$OutputEncoding = [System.Text.Encoding]::UTF8
chcp 65001 > $null
```

**解決方法（macOS/Linux）**

`.bashrc`または`.zshrc`に追加:

```bash
export LANG=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8
```

設定を反映:

```bash
source ~/.bashrc  # または ~/.zshrc
```

## バージョン・アップデート関連のエラー

### エラー12: `Update available`という警告

**症状**

```
⚠ A new version of Claude Code is available (1.0.70)
  You are currently using version 1.0.67
  Run 'claude update' to upgrade
```

**原因**
- 新しいバージョンがリリースされている

**解決方法: アップデート**

```bash
claude update
```

または、npmで手動アップデート:

```bash
npm update -g @anthropic-ai/claude-code
```

アップデート後、バージョン確認:

```bash
claude --version
```

### エラー13: アップデート後に動作しなくなった

**症状**

アップデート後、Claude Codeが起動しない、またはエラーが出る。

**解決方法1: クリーンインストール**

```bash
# アンインストール
npm uninstall -g @anthropic-ai/claude-code

# npmのキャッシュをクリア
npm cache clean --force

# 再インストール
npm install -g @anthropic-ai/claude-code
```

**解決方法2: 認証情報のリセット**

```bash
rm ~/.claude/credentials.json
claude
# 再度認証
```

**解決方法3: 設定ファイルのリセット**

```bash
# バックアップを取ってから削除
mv ~/.claude ~/.claude.backup

# Claude Codeを起動（初回セットアップが始まる）
claude
```

問題が解決したら、バックアップから必要な設定を戻します。

## その他のエラー

### エラー14: `Out of memory` / メモリ不足

**症状**

```
╭──────────────────────────────────────────────╮
│ ✗ Out of memory                              │
│   The process ran out of memory               │
╰──────────────────────────────────────────────╯
```

**原因**
- 会話が長すぎる
- 大量のファイルを分析している

**解決方法**

1. 会話を圧縮:
   ```bash
   > /compact
   ```

2. 会話をクリア:
   ```bash
   > /clear
   ```

3. セッションを再起動:
   ```bash
   [Ctrl+C] [Ctrl+C]
   claude
   ```

### エラー15: `Cannot read CLAUDE.md`

**症状**

```
⚠ Warning: Could not read CLAUDE.md
  File may be corrupted or unreadable
```

**原因**
- CLAUDE.mdが破損している
- ファイルの権限がない

**解決方法**

1. ファイルの権限を確認:
   ```bash
   ls -la CLAUDE.md
   ```

2. 権限を修正:
   ```bash
   chmod 644 CLAUDE.md
   ```

3. ファイルが破損している場合は削除して再生成:
   ```bash
   rm CLAUDE.md
   > /init
   ```

## トラブルシューティングのステップ

問題が発生したときの一般的な対処手順:

### ステップ1: 基本的な確認

```bash
# 1. インターネット接続を確認
ping google.com

# 2. Claude Code のバージョン確認
claude --version

# 3. Node.js のバージョン確認
node --version

# 4. 健全性チェック
claude
> /doctor
```

### ステップ2: 認証の確認

```bash
# 認証情報を削除して再認証
rm ~/.claude/credentials.json
claude
# 認証フローをやり直す
```

### ステップ3: クリーンインストール

```bash
# 1. アンインストール
npm uninstall -g @anthropic-ai/claude-code

# 2. キャッシュクリア
npm cache clean --force

# 3. 再インストール
npm install -g @anthropic-ai/claude-code

# 4. 確認
claude --version
```

### ステップ4: ログの確認

Claude Codeのログファイルを確認:

```bash
# ログファイルの場所
ls -la ~/.claude/logs/

# 最新のログを表示
tail -n 50 ~/.claude/logs/latest.log
```

エラーメッセージをコピーして、公式ドキュメントで検索してください。

## サポートを受ける方法

### 公式リソース

1. **公式ドキュメント**
   - [https://docs.anthropic.com/claude-code](https://docs.anthropic.com/claude-code)

2. **GitHub Issue**
   - バグ報告や機能リクエスト
   - 過去の類似問題を検索

3. **コミュニティフォーラム**
   - 他のユーザーからのアドバイス

### 問題報告時に含めるべき情報

1. **環境情報**
   ```bash
   claude --version
   node --version
   npm --version
   # OS情報（macOS、Windows、Linux）
   ```

2. **エラーメッセージ**
   - 完全なエラーメッセージ
   - スクリーンショット

3. **再現手順**
   - 何をしたときにエラーが発生したか
   - 最小限の再現手順

4. **ログファイル**
   - `~/.claude/logs/latest.log` の内容（個人情報は削除）

## まとめ

よくあるエラーと解決方法:

**インストール関連**
- `command not found` → パスの設定
- `permission denied` → グローバルディレクトリの変更

**認証関連**
- `Authentication failed` → 認証情報のリセット
- `Invalid API key` → 新しいキーを生成

**ネットワーク関連**
- `Network error` → 接続確認、プロキシ設定
- `Rate limit` → 待機、モデル切り替え

**動作関連**
- 固まる → Escで中断、再起動
- 許可を求められる → 権限設定

問題が解決しない場合は、公式サポートに問い合わせることをおすすめします。

第2章はこれで完了です。次章では、Claude Codeの基本操作について詳しく学んでいきます！
