# B2. エラー別トラブルシューティング

## エラー診断フローチャート

```
エラー発生
│
├─ インストール/起動時のエラー → セクションA
├─ 認証/API関連のエラー → セクションB
├─ ファイル操作のエラー → セクションC
├─ パフォーマンス問題 → セクションD
└─ その他のエラー → セクションE
```

---

## セクションA: インストール/起動時のエラー

### A-1: "command not found: claude-code"

**エラーメッセージ:**
```bash
$ claude-code
zsh: command not found: claude-code
```

**原因:**
Claude Codeがインストールされていない、またはPATHが通っていない

**解決策:**

```bash
# Step 1: インストール確認
npm list -g @anthropic-ai/claude-code

# インストールされていない場合
npm install -g @anthropic-ai/claude-code

# Step 2: PATHの確認
echo $PATH | grep $(npm config get prefix)

# PATHが通っていない場合、追加
echo 'export PATH="$(npm config get prefix)/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# または~/.zshrcの場合
echo 'export PATH="$(npm config get prefix)/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc

# Step 3: 動作確認
which claude-code
claude-code --version
```

---

### A-2: "Cannot find module '@anthropic-ai/sdk'"

**エラーメッセージ:**
```bash
Error: Cannot find module '@anthropic-ai/sdk'
```

**原因:**
依存関係が正しくインストールされていない

**解決策:**

```bash
# Step 1: npmキャッシュをクリア
npm cache clean --force

# Step 2: グローバルパッケージを削除
npm uninstall -g @anthropic-ai/claude-code

# Step 3: Node.jsバージョン確認（18以上が必要）
node --version

# バージョンが古い場合は更新
# nvm使用の場合
nvm install 20
nvm use 20

# Step 4: 再インストール
npm install -g @anthropic-ai/claude-code

# Step 5: 動作確認
claude-code --version
```

---

### A-3: "EACCES: permission denied"

**エラーメッセージ:**
```bash
npm ERR! code EACCES
npm ERR! syscall access
npm ERR! path /usr/local/lib/node_modules
npm ERR! errno -13
```

**原因:**
npmのグローバルインストールに権限がない

**解決策:**

```bash
# 方法1: npmのデフォルトディレクトリを変更（推奨）
mkdir -p ~/.npm-global
npm config set prefix '~/.npm-global'

# PATHに追加
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 再度インストール
npm install -g @anthropic-ai/claude-code

# 方法2: sudoを使用（非推奨）
sudo npm install -g @anthropic-ai/claude-code

# 方法3: nvmを使用（推奨）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
npm install -g @anthropic-ai/claude-code
```

---

## セクションB: 認証/API関連のエラー

### B-1: "Invalid API key"

**エラーメッセージ:**
```bash
Error: Invalid API key provided
Status: 401 Unauthorized
```

**原因:**
APIキーが無効、または正しく設定されていない

**解決策:**

```bash
# Step 1: APIキーの確認
cat ~/.claude/config.json

# Step 2: APIキーの形式確認
# 正しい形式: sk-ant-api03-...

# Step 3: 新しいAPIキーを取得
# https://console.anthropic.com/settings/keys

# Step 4: 設定ファイルを更新
nano ~/.claude/config.json

# 以下の形式で記述
{
  "apiKey": "sk-ant-api03-YOUR_NEW_KEY_HERE"
}

# Step 5: ファイルの権限確認
chmod 600 ~/.claude/config.json

# Step 6: Claude Codeを再起動
claude-code
```

---

### B-2: "Rate limit exceeded"

**エラーメッセージ:**
```bash
Error: Rate limit exceeded
Status: 429 Too Many Requests
Retry-After: 60
```

**原因:**
APIリクエストのレート制限に達した

**解決策:**

```bash
# Step 1: 現在のレート制限を確認
# Claude Sonnet: 50リクエスト/分
# Claude Haiku: 100リクエスト/分

# Step 2: 待機時間を確認
# エラーメッセージの"Retry-After"を参照（秒数）

# Step 3: 設定でリトライを有効化
# settings.json
{
  "retryAttempts": 3,
  "retryDelay": 5000,
  "exponentialBackoff": true
}

# Step 4: モデルを変更（一時的な対策）
/model claude-3-haiku

# Step 5: リクエストを分散
# 大量のファイルを一度に処理せず、分割して実行
```

**予防策:**
```bash
# バッチ処理を避ける
# ❌ 一度に50ファイルを処理
# ✅ 10ファイルずつ5回に分けて処理

# Plan modeを活用
/plan  # 計画を立てる
/execute  # 実行（1リクエストで効率的に）
```

---

### B-3: "Network timeout"

**エラーメッセージ:**
```bash
Error: Request timeout
Failed to connect to api.anthropic.com
```

**原因:**
ネットワーク接続の問題、またはタイムアウト設定

**解決策:**

```bash
# Step 1: ネットワーク接続確認
ping api.anthropic.com
curl -I https://api.anthropic.com

# Step 2: プロキシ設定確認（企業ネットワーク等）
echo $HTTP_PROXY
echo $HTTPS_PROXY

# プロキシ設定が必要な場合
export HTTP_PROXY=http://proxy.example.com:8080
export HTTPS_PROXY=http://proxy.example.com:8080

# 恒久的に設定
echo 'export HTTP_PROXY=http://proxy.example.com:8080' >> ~/.bashrc
echo 'export HTTPS_PROXY=http://proxy.example.com:8080' >> ~/.bashrc

# Step 3: タイムアウト時間を延長
# settings.json
{
  "timeout": 120000,  // 120秒（デフォルト: 60秒）
  "connectTimeout": 30000
}

# Step 4: DNSキャッシュをクリア
# macOS
sudo dscacheutil -flushcache
sudo killall -HUP mDNSResponder

# Linux
sudo systemd-resolve --flush-caches

# Windows
ipconfig /flushdns
```

---

## セクションC: ファイル操作のエラー

### C-1: "Permission denied: cannot read file"

**エラーメッセージ:**
```bash
Error: EACCES: permission denied, open '/path/to/file.ts'
```

**原因:**
ファイルの読み取り権限がない

**解決策:**

```bash
# Step 1: ファイルの権限確認
ls -la /path/to/file.ts

# Step 2: 権限を修正
chmod 644 /path/to/file.ts

# ディレクトリの権限も確認
chmod 755 /path/to/

# Step 3: 所有者を確認
ls -l /path/to/file.ts

# 所有者を変更（必要な場合）
sudo chown $USER:$USER /path/to/file.ts

# Step 4: settings.jsonのパーミッション設定確認
cat .claude/settings.json

# 読み取り権限を追加
{
  "permissions": {
    "read": ["src/**/*", "path/to/**/*"]
  }
}
```

---

### C-2: "File not found"

**エラーメッセージ:**
```bash
Error: ENOENT: no such file or directory, open '/path/to/file.ts'
```

**原因:**
ファイルが存在しない、またはパスが間違っている

**解決策:**

```bash
# Step 1: ファイルの存在確認
ls -la /path/to/file.ts

# Step 2: 現在のディレクトリを確認
pwd

# Step 3: 相対パスと絶対パスの確認
# 相対パス: src/file.ts
# 絶対パス: /home/user/project/src/file.ts

# Step 4: ワイルドカードで検索
find . -name "file.ts"

# Step 5: パスの正規化（WSL環境の場合）
# Windowsパス: C:\Users\...\file.ts
# WSLパス: /mnt/c/Users/.../file.ts

# CLAUDE.mdでパス変換を設定
```

---

### C-3: "Cannot write to read-only file"

**エラーメッセージ:**
```bash
Error: Cannot modify file: Permission denied (write protected)
```

**原因:**
ファイルが書き込み保護されている、またはsettings.jsonで書き込みが禁止されている

**解決策:**

```bash
# Step 1: ファイル属性確認
ls -la file.ts

# Step 2: 書き込み権限を追加
chmod u+w file.ts

# Step 3: settings.jsonの設定確認
cat .claude/settings.json

# 書き込み権限を追加
{
  "permissions": {
    "write": ["src/**/*"]
  }
}

# Step 4: denyリストを確認
# denyに含まれていないか確認
{
  "permissions": {
    "deny": {
      "write": ["package.json"]  // これが原因の場合は削除
    }
  }
}
```

---

## セクションD: コンテキスト/メモリ関連のエラー

### D-1: "Context length exceeded"

**エラーメッセージ:**
```bash
Error: Context length exceeded
Maximum tokens: 200000
Current tokens: 250000
```

**原因:**
コンテキストウィンドウの制限を超えた

**解決策:**

```bash
# Step 1: コンテキストをクリア
/clear-context

# Step 2: 不要なファイルを除外
# settings.json
{
  "ignoreDirs": [
    "node_modules",
    "dist",
    "build",
    ".next",
    "coverage"
  ],
  "ignorePatterns": [
    "*.log",
    "*.map",
    "*.min.js"
  ]
}

# Step 3: 必要なファイルだけを指定
/context src/specific-file.ts

# Step 4: 大きなタスクを分割
# ❌ 一度に全ファイルをリファクタリング
# ✅ 1ファイルずつ、または小さなモジュールごと

# Step 5: ファイルサイズを確認
du -sh .claude/context/

# Step 6: セッションを再開
exit
claude-code
```

---

### D-2: "Memory allocation failed"

**エラーメッセージ:**
```bash
Error: JavaScript heap out of memory
FATAL ERROR: Reached heap limit
```

**原因:**
Node.jsのメモリ制限を超えた

**解決策:**

```bash
# Step 1: Node.jsのメモリ上限を増やす
export NODE_OPTIONS="--max-old-space-size=4096"

# 恒久的に設定
echo 'export NODE_OPTIONS="--max-old-space-size=4096"' >> ~/.bashrc
source ~/.bashrc

# Step 2: キャッシュをクリア
rm -rf ~/.claude/cache

# Step 3: 大きなファイルを除外
# settings.json
{
  "maxFileSize": 1048576,  // 1MB
  "ignoreLargeFiles": true
}

# Step 4: プロセスを再起動
claude-code
```

---

## セクションE: その他のエラー

### E-1: "Git operation failed"

**エラーメッセージ:**
```bash
Error: Git command failed
fatal: not a git repository
```

**原因:**
Gitリポジトリが初期化されていない、またはGitコマンドの権限がない

**解決策:**

```bash
# Step 1: Gitリポジトリの初期化確認
git status

# 初期化されていない場合
git init

# Step 2: Git設定確認
git config user.name
git config user.email

# 設定されていない場合
git config --global user.name "Your Name"
git config --global user.email "your@email.com"

# Step 3: settings.jsonでGit権限確認
{
  "permissions": {
    "execute": [
      "git status",
      "git diff",
      "git add",
      "git commit"
    ]
  }
}

# Step 4: Gitコマンドのパス確認
which git

# Step 5: WSL環境の場合、Windowsのgitとの競合確認
# WSL内のgitを使用するように設定
```

---

### E-2: "JSON parse error"

**エラーメッセージ:**
```bash
Error: Unexpected token } in JSON at position 45
SyntaxError: Invalid JSON
```

**原因:**
設定ファイルのJSON形式が不正

**解決策:**

```bash
# Step 1: 設定ファイルの構文チェック
cat .claude/settings.json | jq .

# jqがない場合はインストール
# macOS: brew install jq
# Linux: sudo apt install jq

# Step 2: JSONフォーマッタで整形
cat .claude/settings.json | jq . > temp.json
mv temp.json .claude/settings.json

# Step 3: よくあるJSON エラー
# ❌ 最後のカンマ
{
  "key": "value",  // ← この最後のカンマを削除
}

# ✅ 正しい形式
{
  "key": "value"
}

# ❌ シングルクォート
{'key': 'value'}

# ✅ ダブルクォート
{"key": "value"}

# Step 4: バックアップから復元
cp .claude/settings.json.backup .claude/settings.json
```

---

### E-3: "Module resolution failed"

**エラーメッセージ:**
```bash
Error: Cannot find module 'typescript'
Module not found: Can't resolve 'react'
```

**原因:**
依存関係がインストールされていない

**解決策:**

```bash
# Step 1: package.jsonの存在確認
ls -la package.json

# Step 2: 依存関係をインストール
npm install

# または
yarn install
# または
pnpm install

# Step 3: node_modulesが存在するか確認
ls -la node_modules/

# Step 4: 特定のパッケージを再インストール
npm install typescript --save-dev

# Step 5: キャッシュをクリアして再インストール
rm -rf node_modules package-lock.json
npm install

# Step 6: TypeScriptの設定確認（該当する場合）
cat tsconfig.json
npx tsc --noEmit  # 型チェックのみ
```

---

## エラー診断ツール

### 診断スクリプト

```bash
#!/bin/bash
# claude-code-diagnosis.sh

echo "========================================="
echo "Claude Code 診断スクリプト"
echo "========================================="
echo ""

# 1. Claude Codeのインストール確認
echo "[1] Claude Code インストール確認"
if command -v claude-code &> /dev/null; then
    echo "✓ claude-code コマンドが見つかりました"
    claude-code --version
else
    echo "✗ claude-code コマンドが見つかりません"
fi
echo ""

# 2. Node.js確認
echo "[2] Node.js 確認"
if command -v node &> /dev/null; then
    echo "✓ Node.js バージョン: $(node --version)"
else
    echo "✗ Node.jsがインストールされていません"
fi
echo ""

# 3. npm確認
echo "[3] npm 確認"
if command -v npm &> /dev/null; then
    echo "✓ npm バージョン: $(npm --version)"
else
    echo "✗ npmがインストールされていません"
fi
echo ""

# 4. API設定確認
echo "[4] API設定確認"
if [ -f ~/.claude/config.json ]; then
    echo "✓ config.json が存在します"
    if grep -q "apiKey" ~/.claude/config.json; then
        echo "✓ APIキーが設定されています"
    else
        echo "✗ APIキーが設定されていません"
    fi
else
    echo "✗ config.json が存在しません"
fi
echo ""

# 5. ネットワーク接続確認
echo "[5] ネットワーク接続確認"
if ping -c 1 api.anthropic.com &> /dev/null; then
    echo "✓ api.anthropic.com に接続できます"
else
    echo "✗ api.anthropic.com に接続できません"
fi
echo ""

# 6. Git確認
echo "[6] Git 確認"
if command -v git &> /dev/null; then
    echo "✓ Git バージョン: $(git --version)"
    if git rev-parse --is-inside-work-tree &> /dev/null; then
        echo "✓ Gitリポジトリ内です"
    else
        echo "! Gitリポジトリではありません"
    fi
else
    echo "✗ Gitがインストールされていません"
fi
echo ""

# 7. 権限確認
echo "[7] 権限確認"
if [ -d ~/.claude ]; then
    echo "✓ ~/.claude ディレクトリが存在します"
    ls -ld ~/.claude
else
    echo "✗ ~/.claude ディレクトリが存在しません"
fi
echo ""

echo "========================================="
echo "診断完了"
echo "========================================="
```

### 使用方法

```bash
# スクリプトを保存
nano claude-code-diagnosis.sh

# 実行権限を付与
chmod +x claude-code-diagnosis.sh

# 実行
./claude-code-diagnosis.sh
```

---

## まとめ

エラーが発生した場合の基本的な対処フロー:

1. **エラーメッセージを確認** - 正確なエラー内容を把握
2. **ログを確認** - `~/.claude/logs/`
3. **設定ファイルをチェック** - CLAUDE.md, settings.json
4. **キャッシュをクリア** - `rm -rf ~/.claude/cache`
5. **再起動** - Claude Codeを完全に終了して再起動
6. **診断スクリプトを実行** - 包括的な問題チェック
7. **公式ドキュメント参照** - https://docs.anthropic.com/

それでも解決しない場合は、次章のパフォーマンス問題の解決を参照してください。
