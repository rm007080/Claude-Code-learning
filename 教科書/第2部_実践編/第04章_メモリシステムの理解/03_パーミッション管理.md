# 03. パーミッション管理

## この章で学ぶこと

Claude Codeのパーミッション（権限）システムの詳細を学びます。allow/denyの高度な使い方、ワイルドカードパターン、そしてセキュリティを確保しながら開発効率を最大化する方法を習得します。

## パーミッションシステムの仕組み

パーミッションシステムは、Claude Codeが実行できる操作を制御する「門番」の役割を果たします。

### 3段階の判断プロセス

Claude Codeがコマンドや操作を実行しようとする時、以下の順序で判断されます:

```
1. denyリストに一致？
   ↓ YES → 実行を拒否（赤信号）
   ↓ NO
2. allowリストに一致？
   ↓ YES → 自動実行（青信号）
   ↓ NO
3. ユーザーに確認を求める（黄信号）
```

この優先順位により、**denyは常にallowより優先**されます。

## パーミッションの記述形式

### 基本的な構造

```json
{
  "permissions": {
    "allow": [
      "ツール名(パターン)"
    ],
    "deny": [
      "ツール名(パターン)"
    ]
  }
}
```

### 主要なツール種類

Claude Codeで制御できる主なツールは以下の通りです:

1. **Bash**: シェルコマンドの実行
2. **Read**: ファイルの読み込み
3. **Write**: ファイルの書き込み
4. **Edit**: ファイルの編集
5. **Glob**: ファイルパターン検索

## ワイルドカードパターン

ワイルドカードを使用することで、柔軟なパターンマッチングが可能です。

### 基本的なワイルドカード

#### `*` (アスタリスク) - 任意の文字列

```json
{
  "permissions": {
    "allow": [
      "Bash(npm test:*)",      // npm test:unit, npm test:e2e など
      "Read(src/**/*)",         // srcディレクトリ内のすべて
      "Write(*.md)"             // すべてのMarkdownファイル
    ]
  }
}
```

#### `**` (ダブルアスタリスク) - 任意の階層

```json
{
  "permissions": {
    "allow": [
      "Read(**/*.test.ts)",     // 全階層のテストファイル
      "Write(src/**/*.tsx)"     // srcディレクトリ内の全TSXファイル
    ]
  }
}
```

#### `?` (クエスチョン) - 任意の1文字

```json
{
  "permissions": {
    "allow": [
      "Read(config?.json)"      // config1.json, config2.json など
    ]
  }
}
```

### 実践的なパターン例

#### 複数の拡張子を許可

```json
{
  "permissions": {
    "allow": [
      "Read(src/**/*.{ts,tsx,js,jsx})"
    ]
  }
}
```

#### 特定のディレクトリを除外

```json
{
  "permissions": {
    "deny": [
      "Read(node_modules/**/*)",
      "Read(dist/**/*)",
      "Read(.git/**/*)"
    ]
  }
}
```

#### コマンドの引数パターン

```json
{
  "permissions": {
    "allow": [
      "Bash(git status)",
      "Bash(git diff:*)",
      "Bash(git log:*)"
    ],
    "deny": [
      "Bash(git push:*)",
      "Bash(git reset:*)",
      "Bash(git rebase:*)"
    ]
  }
}
```

## Bashコマンドのパーミッション

### 安全に許可できるコマンド

```json
{
  "permissions": {
    "allow": [
      // ファイル操作（読み取り系）
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(grep:*)",
      "Bash(find:*)",
      "Bash(tree:*)",

      // ファイル操作（作成系）
      "Bash(mkdir:*)",
      "Bash(touch:*)",
      "Bash(echo:*)",

      // ファイル操作（移動・コピー）
      "Bash(mv:*)",
      "Bash(cp:*)",

      // 開発コマンド
      "Bash(npm run dev)",
      "Bash(npm run build)",
      "Bash(npm test:*)",
      "Bash(npm run lint:*)",

      // Git（安全な操作）
      "Bash(git status)",
      "Bash(git diff:*)",
      "Bash(git log:*)",
      "Bash(git branch:*)",

      // ユーティリティ
      "Bash(date)",
      "Bash(pwd)",
      "Bash(whoami)"
    ]
  }
}
```

### 注意が必要なコマンド（確認推奨）

これらのコマンドはallowにもdenyにも含めず、都度確認するのが安全です:

```json
// 設定ファイルに記載しない = 都度確認
- npm install
- git add
- git commit
- git push
- rm（削除コマンド）
- chmod（権限変更）
```

### 絶対に許可してはいけないコマンド

```json
{
  "permissions": {
    "deny": [
      // システム管理
      "Bash(sudo:*)",
      "Bash(su:*)",

      // 危険な削除
      "Bash(rm -rf:*)",
      "Bash(rm -r:*)",

      // 危険なGit操作
      "Bash(git reset --hard:*)",
      "Bash(git push --force:*)",
      "Bash(git rebase:*)",

      // ネットワーク経由のダウンロード
      "Bash(wget:*)",
      "Bash(curl:*| bash)",

      // パッケージ公開
      "Bash(npm publish:*)",
      "Bash(yarn publish:*)"
    ]
  }
}
```

## ファイル操作のパーミッション

### Read（読み込み）のパーミッション

#### 許可すべきファイル

```json
{
  "permissions": {
    "allow": [
      // ソースコード
      "Read(src/**/*)",
      "Read(lib/**/*)",

      // テストファイル
      "Read(tests/**/*)",
      "Read(**/*.test.ts)",
      "Read(**/*.spec.ts)",

      // 設定ファイル
      "Read(package.json)",
      "Read(tsconfig.json)",
      "Read(*.config.js)",

      // ドキュメント
      "Read(*.md)",
      "Read(docs/**/*)"
    ]
  }
}
```

#### 絶対に読ませてはいけないファイル

```json
{
  "permissions": {
    "deny": [
      // 環境変数ファイル
      "Read(.env)",
      "Read(.env.*)",
      "Read(**/.env*)",

      // 認証情報
      "Read(**/*secret*)",
      "Read(**/*token*)",
      "Read(**/*password*)",
      "Read(**/*key*)",

      // SSHキー
      "Read(id_rsa)",
      "Read(id_ed25519)",
      "Read(*.pem)",

      // データベース認証情報
      "Read(config/database.yml)",
      "Read(config/secrets.yml)",

      // クラウド認証情報
      "Read(.aws/credentials)",
      "Read(.gcloud/credentials)"
    ]
  }
}
```

### Write（書き込み）のパーミッション

#### 許可すべきファイル

```json
{
  "permissions": {
    "allow": [
      // ソースコード
      "Write(src/**/*)",
      "Write(lib/**/*)",

      // テストファイル
      "Write(tests/**/*)",
      "Write(**/*.test.ts)",

      // ドキュメント
      "Write(docs/**/*)",
      "Write(*.md)"
    ]
  }
}
```

#### 保護すべきファイル

```json
{
  "permissions": {
    "deny": [
      // 依存関係ファイル
      "Write(package.json)",
      "Write(package-lock.json)",
      "Write(yarn.lock)",
      "Write(pnpm-lock.yaml)",

      // 設定ファイル
      "Write(tsconfig.json)",
      "Write(.eslintrc.*)",
      "Write(.prettierrc.*)",

      // 環境変数ファイル
      "Write(.env*)",
      "Write(**/*secret*)",

      // システムファイル
      "Write(/etc/**/*)",
      "Write(/usr/**/*)",
      "Write(/System/**/*)"
    ]
  }
}
```

## 環境別のパーミッション設定

### 開発環境

最も緩和された設定（ただし安全性は確保）

```json
{
  "permissions": {
    "allow": [
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(mkdir:*)",
      "Bash(touch:*)",
      "Bash(npm:*)",
      "Bash(git status)",
      "Bash(git diff:*)",
      "Read(src/**/*)",
      "Read(tests/**/*)",
      "Write(src/**/*)",
      "Write(tests/**/*)",
      "Write(docs/**/*)"
    ],
    "deny": [
      "Bash(sudo:*)",
      "Bash(rm -rf:*)",
      "Read(.env*)",
      "Write(.env*)",
      "Bash(git push --force:*)"
    ]
  }
}
```

### CI/CD環境

より厳格な設定

```json
{
  "permissions": {
    "allow": [
      "Bash(npm ci)",
      "Bash(npm run build)",
      "Bash(npm test)",
      "Bash(npm run lint)",
      "Read(src/**/*)",
      "Read(tests/**/*)"
    ],
    "deny": [
      "Bash(sudo:*)",
      "Bash(rm:*)",
      "Bash(git:*)",
      "Write(**/*)",
      "Read(.env*)"
    ]
  }
}
```

### 本番環境

Claude Codeの使用は推奨されませんが、必要な場合は最も厳格に:

```json
{
  "permissions": {
    "allow": [
      "Bash(git status)",
      "Read(logs/**/*)",
      "Read(*.log)"
    ],
    "deny": [
      "Bash(*)",
      "Write(**/*)",
      "Read(.env*)",
      "Read(config/**/*)"
    ]
  }
}
```

## セキュリティベストプラクティス

### 1. 最小権限の原則

必要最小限の権限のみを付与します。

```json
// ❌ 悪い例：すべてを許可
{
  "permissions": {
    "allow": ["*"]
  }
}

// ✅ 良い例：必要なものだけ許可
{
  "permissions": {
    "allow": [
      "Bash(npm test)",
      "Read(src/**/*.ts)",
      "Write(src/**/*.ts)"
    ]
  }
}
```

### 2. denyリストを活用

危険な操作は明示的に拒否します。

```json
{
  "permissions": {
    "deny": [
      // システムレベルの操作
      "Bash(sudo:*)",
      "Bash(su:*)",

      // 危険な削除
      "Bash(rm -rf:*)",

      // 機密情報
      "Read(.env*)",
      "Read(**/*secret*)",
      "Read(**/*key*)",

      // 本番環境への影響
      "Bash(*production*)",
      "Write(**/*production*)"
    ]
  }
}
```

### 3. 環境変数の保護

環境変数ファイルは複数パターンで保護します。

```json
{
  "permissions": {
    "deny": [
      "Read(.env)",
      "Read(.env.*)",
      "Read(**/.env*)",
      "Read(**/*.env)",
      "Write(.env*)",
      "Write(**/.env*)"
    ]
  }
}
```

### 4. Gitの危険な操作を防ぐ

```json
{
  "permissions": {
    "deny": [
      // 強制プッシュ
      "Bash(git push --force:*)",
      "Bash(git push -f:*)",

      // 破壊的な操作
      "Bash(git reset --hard:*)",
      "Bash(git rebase:*)",
      "Bash(git clean -fd:*)",

      // ブランチ削除
      "Bash(git branch -D:*)",
      "Bash(git push origin --delete:*)"
    ]
  }
}
```

### 5. 本番環境の分離

```json
{
  "permissions": {
    "deny": [
      "Bash(*production*)",
      "Bash(*prod*)",
      "Read(**/*production*)",
      "Write(**/*production*)",
      "Bash(heroku:*)",
      "Bash(kubectl:*production*)"
    ]
  }
}
```

## トラブルシューティング

### 問題1: 必要な操作が拒否される

**症状**: 安全なコマンドが実行できない

**解決策**:
1. allowリストに追加
2. denyリストに意図せず含まれていないか確認

```json
// 例: npm testが実行できない
{
  "permissions": {
    "allow": [
      "Bash(npm test)",
      "Bash(npm run test:*)"
    ]
  }
}
```

### 問題2: denyリストが効かない

**症状**: 禁止したはずの操作が実行される

**原因**: allowリストより後に記載している

**解決策**: settings.jsonの記述順序ではなく、内部の優先順位が重要。denyは常に優先されます。JSONの構文エラーを確認してください。

```bash
# JSON構文チェック
cat .claude/settings.json | jq .
```

### 問題3: パターンが一致しない

**症状**: ワイルドカードが期待通り動作しない

**解決策**: パターンを段階的にテストする

```json
// 段階的に詳細化
"Read(src/*)"           // srcの直下のみ
"Read(src/**/*)"        // srcのすべての階層
"Read(src/**/*.ts)"     // srcのすべてのTSファイル
```

## 実践例: プロジェクトタイプ別設定

### React/Next.jsプロジェクト

```json
{
  "permissions": {
    "allow": [
      "Bash(npm run dev)",
      "Bash(npm run build)",
      "Bash(npm test:*)",
      "Bash(npm run lint:*)",
      "Bash(npm run typecheck)",
      "Read(src/**/*)",
      "Read(pages/**/*)",
      "Read(app/**/*)",
      "Read(public/**/*)",
      "Write(src/**/*)",
      "Write(pages/**/*)",
      "Write(app/**/*)"
    ],
    "deny": [
      "Read(.env.local)",
      "Read(.env.production)",
      "Write(next.config.js)",
      "Bash(npm run deploy:*)"
    ]
  }
}
```

### Node.js APIプロジェクト

```json
{
  "permissions": {
    "allow": [
      "Bash(npm run dev)",
      "Bash(npm test:*)",
      "Bash(npm run db:migrate)",
      "Bash(npx prisma:*)",
      "Read(src/**/*)",
      "Read(tests/**/*)",
      "Write(src/**/*)",
      "Write(tests/**/*)",
      "Write(prisma/migrations/**/*)"
    ],
    "deny": [
      "Read(.env*)",
      "Write(prisma/schema.prisma)",
      "Bash(npm run db:drop)",
      "Bash(npm run db:reset)",
      "Bash(*production*)"
    ]
  }
}
```

### Python/Django プロジェクト

```json
{
  "permissions": {
    "allow": [
      "Bash(python manage.py runserver)",
      "Bash(python manage.py test:*)",
      "Bash(python manage.py makemigrations)",
      "Bash(python manage.py migrate)",
      "Bash(pytest:*)",
      "Read(**/*.py)",
      "Write(**/*.py)",
      "Write(tests/**/*)"
    ],
    "deny": [
      "Read(*.env)",
      "Read(settings/production.py)",
      "Bash(python manage.py flush)",
      "Bash(python manage.py dbshell)"
    ]
  }
}
```

## --dangerously-skip-permissionsフラグ

### 概要

このフラグを使用すると、すべての権限確認をスキップします。

```bash
claude --dangerously-skip-permissions
```

### ⚠️ 警告

このフラグは名前の通り危険です。使用する場合は以下の対策が必須です:

1. **Dockerコンテナ内で実行**
2. **denyリストを徹底的に設定**
3. **重要なファイルをバックアップ**
4. **本番環境では絶対に使用しない**

### 安全に使用する場合の設定例

```json
{
  "permissions": {
    "deny": [
      "Bash(sudo:*)",
      "Bash(rm -rf:*)",
      "Bash(git push:*)",
      "Bash(git reset:*)",
      "Read(.env*)",
      "Read(**/*secret*)",
      "Read(**/*key*)",
      "Write(.env*)",
      "Write(package.json)",
      "Bash(npm publish:*)"
    ]
  }
}
```

## まとめ

### 重要ポイント

1. **3段階の判断プロセス**
   - deny → allow → 確認

2. **ワイルドカードの活用**
   - `*`: 任意の文字列
   - `**`: 任意の階層
   - 適切なパターンで柔軟に制御

3. **セキュリティ最優先**
   - 最小権限の原則
   - 機密情報の保護
   - 危険な操作の明示的な拒否

4. **段階的な設定構築**
   - 最初は最小限から
   - 必要に応じて追加
   - 定期的な見直し

### チェックリスト

開発開始前に以下を確認:

- [ ] .env*ファイルをdenyに追加
- [ ] 危険な削除コマンドをdenyに追加
- [ ] よく使う安全なコマンドをallowに追加
- [ ] Git の危険な操作をdenyに追加
- [ ] 本番環境関連の操作をdenyに追加

### 次のステップ

次の章では、複数のメモリファイル（CLAUDE.md、settings.json）が存在する場合の読み込み順序と優先順位について詳しく学びます。
