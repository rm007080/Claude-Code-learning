# 04. メモリファイルの階層と優先順位

## この章で学ぶこと

複数のCLAUDE.mdやsettings.jsonが存在する場合、Claude Codeはどのように読み込み、どの設定を優先するのかを学びます。階層構造を理解することで、チーム設定と個人設定を適切に使い分けられるようになります。

## メモリシステムの全体像

Claude Codeのメモリシステムは、以下の6つのファイルから構成されます:

### CLAUDE.md（記憶ファイル）

1. `./CLAUDE.md` - プロジェクトルート
2. `./.claude/CLAUDE.md` - プロジェクト隠しディレクトリ
3. `~/.claude/CLAUDE.md` - ホームディレクトリ

### settings.json（設定ファイル）

4. `./.claude/settings.local.json` - プロジェクトローカル設定
5. `./.claude/settings.json` - プロジェクト設定
6. `~/.claude/settings.json` - グローバル設定

## 優先順位のルール

### CLAUDE.mdの優先順位

より近い場所（プロジェクトに近い場所）が優先されます:

```
1. ./CLAUDE.md                    (最優先)
2. ./.claude/CLAUDE.md            (次優先)
3. ~/.claude/CLAUDE.md            (最低優先)
```

**マージ動作**: すべてのCLAUDE.mdは読み込まれ、**内容が結合**されます。同じ項目がある場合は上位が優先されます。

### settings.jsonの優先順位

settings.jsonも同様に、より近い場所が優先されます:

```
1. ./.claude/settings.local.json  (最優先)
2. ./.claude/settings.json        (次優先)
3. ~/.claude/settings.json        (最低優先)
```

**上書き動作**: 上位の設定が下位の設定を**上書き**します。

## ディレクトリ構造で理解する

### 基本的な構造

```
ホームディレクトリ (~)
└── .claude/
    ├── CLAUDE.md                        # 全プロジェクト共通のルール
    └── settings.json                    # 全プロジェクト共通の設定

プロジェクトA (~/projects/project-a/)
├── CLAUDE.md                            # プロジェクトの概要（公開）
└── .claude/
    ├── CLAUDE.md                        # プロジェクト詳細（公開可）
    ├── settings.json                    # プロジェクト設定（Git管理）
    └── settings.local.json              # 個人設定（Git管理外）

プロジェクトB (~/projects/project-b/)
├── CLAUDE.md
└── .claude/
    ├── settings.json
    └── settings.local.json
```

### 設定の適用範囲

```
~/.claude/                   → すべてのプロジェクトに適用
├── CLAUDE.md               → 個人の基本スタイル
└── settings.json           → 個人の基本権限

project-a/                   → project-aのみに適用
├── CLAUDE.md               → project-aの概要
└── .claude/
    ├── CLAUDE.md           → project-aの詳細ルール
    ├── settings.json       → project-aのチーム設定
    └── settings.local.json → project-aの個人設定
```

## CLAUDE.mdの結合動作

### 実例で理解する

**~/.claude/CLAUDE.md** (グローバル):
```markdown
# 個人の開発スタイル

## 基本ルール
- 常に日本語で返答してください
- TypeScript strict モードを使用
- テスト駆動開発を心がける
```

**./CLAUDE.md** (プロジェクトルート):
```markdown
# ECサイトプロジェクト

## 技術スタック
- Next.js 14
- PostgreSQL
- Prisma ORM

## コーディング規約
- Server Component を優先
- Client Component は必要最小限
```

**./.claude/CLAUDE.md** (プロジェクト詳細):
```markdown
# 詳細な実装ガイドライン

## データフェッチング
- Server Component で直接 fetch
- キャッシュは revalidate で制御

## 認証
- NextAuth.js を使用
- セッション管理は database strategy
```

### 結合後の内容

Claude Codeは以下をすべて読み込みます:

```markdown
# 個人の開発スタイル
## 基本ルール
- 常に日本語で返答してください
- TypeScript strict モードを使用
- テスト駆動開発を心がける

# ECサイトプロジェクト
## 技術スタック
- Next.js 14
- PostgreSQL
- Prisma ORM

## コーディング規約
- Server Component を優先
- Client Component は必要最小限

# 詳細な実装ガイドライン
## データフェッチング
- Server Component で直接 fetch
- キャッシュは revalidate で制御

## 認証
- NextAuth.js を使用
- セッション管理は database strategy
```

### 同じ項目がある場合

**~/.claude/CLAUDE.md**:
```markdown
## コーディング規約
- 関数は100行以内
```

**./CLAUDE.md**:
```markdown
## コーディング規約
- 関数は50行以内
```

**結果**: プロジェクトルートの設定（50行以内）が優先されます。

## settings.jsonの上書き動作

### 実例で理解する

**~/.claude/settings.json** (グローバル):
```json
{
  "permissions": {
    "allow": [
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(npm test)"
    ],
    "deny": [
      "Bash(sudo:*)",
      "Read(.env)"
    ]
  },
  "autoUpdates": true
}
```

**./.claude/settings.json** (プロジェクト):
```json
{
  "permissions": {
    "allow": [
      "Bash(npm run dev)",
      "Bash(npm run build)",
      "Read(src/**/*)"
    ],
    "deny": [
      "Bash(git push:*)"
    ]
  }
}
```

**./.claude/settings.local.json** (ローカル):
```json
{
  "permissions": {
    "allow": [
      "Bash(npm install:*)"
    ]
  }
}
```

### マージ後の内容

```json
{
  "permissions": {
    "allow": [
      // グローバル
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(npm test)",
      // プロジェクト
      "Bash(npm run dev)",
      "Bash(npm run build)",
      "Read(src/**/*)",
      // ローカル
      "Bash(npm install:*)"
    ],
    "deny": [
      // グローバル
      "Bash(sudo:*)",
      "Read(.env)",
      // プロジェクト
      "Bash(git push:*)"
    ]
  },
  "autoUpdates": true  // グローバルから継承
}
```

### 同じキーがある場合

**~/.claude/settings.json**:
```json
{
  "autoUpdates": true
}
```

**./.claude/settings.json**:
```json
{
  "autoUpdates": false
}
```

**結果**: プロジェクト設定（false）が優先されます。

## 使い分けのベストプラクティス

### ~/.claude/ (グローバル)

**用途**: 全プロジェクトで共通の個人設定

**CLAUDE.md の内容**:
```markdown
# 個人の開発スタイル

## 基本方針
- 常に日本語で返答
- コミットメッセージは Conventional Commits 形式
- テストを先に書く（TDD）

## 個人的なコーディング規約
- 関数は単一責任
- 早期リターンを使う
- マジックナンバーは避ける
```

**settings.json の内容**:
```json
{
  "permissions": {
    "allow": [
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(pwd)",
      "Bash(whoami)"
    ],
    "deny": [
      "Bash(sudo:*)",
      "Bash(rm -rf:*)",
      "Read(**/*secret*)",
      "Read(**/*token*)",
      "Read(**/*key*)",
      "Read(id_rsa)",
      "Read(id_ed25519)"
    ]
  },
  "autoUpdates": true
}
```

### ./CLAUDE.md (プロジェクトルート)

**用途**: プロジェクトの概要（README的な役割）

**内容**:
```markdown
# プロジェクト名

## 概要
このプロジェクトの目的と主要機能

## 技術スタック
- Frontend: React 18
- Backend: Node.js
- Database: PostgreSQL

## ディレクトリ構造
```
src/
├── components/
├── pages/
└── api/
```

## よく使うコマンド
- npm run dev: 開発サーバー起動
- npm test: テスト実行
- npm run build: ビルド
```

### ./.claude/ (プロジェクト詳細)

**./.claude/CLAUDE.md の用途**: 詳細な実装ガイドライン

**内容**:
```markdown
# 実装ガイドライン

## コンポーネント設計
- 100行以内に抑える
- props は interface で定義
- export は名前付きエクスポート

## API設計
- RESTful に従う
- エラーは統一フォーマット
- バージョニングを行う

## テスト方針
- カバレッジ 80% 以上
- E2E は主要フローのみ
- モックは最小限
```

**./.claude/settings.json の用途**: チーム共有の権限設定

**内容**:
```json
{
  "permissions": {
    "allow": [
      "Bash(npm run dev)",
      "Bash(npm run build)",
      "Bash(npm test:*)",
      "Bash(npm run lint:*)",
      "Read(src/**/*)",
      "Write(src/**/*)"
    ],
    "deny": [
      "Read(.env.local)",
      "Write(package.json)",
      "Bash(npm publish:*)"
    ]
  }
}
```

**./.claude/settings.local.json の用途**: 個人の実験的設定

**内容**:
```json
{
  "permissions": {
    "allow": [
      "Bash(npm install:*)",  // 自分だけ自動化
      "Write(experimental/**/*)"
    ]
  },
  "env": {
    "DEBUG": "true"
  }
}
```

## Git管理の戦略

### バージョン管理するファイル

```bash
# Gitで管理
./CLAUDE.md
.claude/CLAUDE.md
.claude/settings.json
.claude/commands/  # カスタムコマンド
```

### バージョン管理しないファイル

```bash
# .gitignore に追加
.claude/settings.local.json
.claude/sessions/
```

**.gitignore の設定例**:
```gitignore
# Claude Code 個人設定
.claude/settings.local.json
.claude/sessions/
.claude/*.log
```

## 実践シナリオ

### シナリオ1: 新メンバーのオンボーディング

**状況**: 新しいメンバーがプロジェクトに参加

**推奨設定**:

1. **リポジトリに含める**:
   - `./CLAUDE.md` - プロジェクト概要
   - `.claude/CLAUDE.md` - 実装ガイドライン
   - `.claude/settings.json` - チーム共通の権限

2. **個人で設定する**:
   - `~/.claude/CLAUDE.md` - 個人のコーディングスタイル
   - `~/.claude/settings.json` - 個人の基本権限
   - `.claude/settings.local.json` - プロジェクト個人設定

### シナリオ2: マルチプロジェクト開発

**状況**: 複数のプロジェクトを同時に開発

**推奨設定**:

```
~/.claude/
├── CLAUDE.md          # 共通の個人スタイル
└── settings.json      # 共通の基本権限

project-frontend/
└── .claude/
    ├── settings.json  # フロントエンド用権限
    └── CLAUDE.md      # フロントエンド実装ルール

project-backend/
└── .claude/
    ├── settings.json  # バックエンド用権限
    └── CLAUDE.md      # バックエンド実装ルール
```

### シナリオ3: チーム開発での権限管理

**状況**: チームで開発、個人ごとに権限を調整したい

**推奨設定**:

**.claude/settings.json** (チーム共有):
```json
{
  "permissions": {
    "allow": [
      "Bash(npm test:*)",
      "Read(src/**/*)"
    ],
    "deny": [
      "Bash(git push:*)",
      "Bash(npm publish:*)"
    ]
  }
}
```

**.claude/settings.local.json** (個人A):
```json
{
  "permissions": {
    "allow": [
      "Bash(npm install:*)"  // Aさんだけ自動化
    ]
  }
}
```

**.claude/settings.local.json** (個人B):
```json
{
  "permissions": {
    "allow": [
      "Bash(git commit:*)"  // Bさんだけ自動化
    ]
  }
}
```

## トラブルシューティング

### 問題1: 設定が反映されない

**確認手順**:

```bash
# 1. ファイルの存在確認
ls -la CLAUDE.md
ls -la .claude/CLAUDE.md
ls -la ~/.claude/CLAUDE.md
ls -la .claude/settings.json
ls -la .claude/settings.local.json
ls -la ~/.claude/settings.json

# 2. JSON構文チェック
cat .claude/settings.json | jq .
cat .claude/settings.local.json | jq .

# 3. セッション再起動
# Claude Codeを終了して再起動
```

### 問題2: 優先順位がわからない

**確認方法**:

```bash
# Claude Code内で確認
> 現在読み込んでいるCLAUDE.mdの内容を教えてください
> 現在の権限設定を教えてください
```

### 問題3: 設定が競合している

**デバッグ手順**:

1. 各ファイルの内容を確認
2. 同じ項目を探す
3. 優先順位に従って整理

**ツール**:
```bash
# すべてのCLAUDE.mdを表示
cat ~/.claude/CLAUDE.md
cat ./CLAUDE.md
cat .claude/CLAUDE.md

# すべてのsettings.jsonを表示
cat ~/.claude/settings.json
cat .claude/settings.json
cat .claude/settings.local.json
```

## 設定の動作確認

### 1分でできる優先順位テスト

**ステップ1: 異なる合言葉を設定**

```bash
# グローバル
echo "GLOBAL_MEMORY" >> ~/.claude/CLAUDE.md

# プロジェクトルート
echo "ROOT_MEMORY" >> ./CLAUDE.md

# プロジェクト詳細
mkdir -p .claude
echo "PROJECT_MEMORY" >> .claude/CLAUDE.md
```

**ステップ2: Claude Codeで確認**

```bash
claude

> 「GLOBAL_MEMORY」「ROOT_MEMORY」「PROJECT_MEMORY」のうち、
  どれが見えていますか？すべて教えてください。
```

**期待される結果**: すべて見えているはずです。

**ステップ3: 優先順位を確認**

```bash
# 各ファイルに同じセクション名で異なる内容を書く
# グローバル
echo "## テストルール\n- グローバルのルール" >> ~/.claude/CLAUDE.md

# ルート
echo "## テストルール\n- ルートのルール" >> ./CLAUDE.md
```

```bash
> 「テストルール」には何が書かれていますか？
```

**期待される結果**: 「ルートのルール」が優先されます。

## まとめ

### 重要ポイント

1. **優先順位の理解**
   - プロジェクトに近い > 遠い
   - ローカル > プロジェクト > グローバル

2. **CLAUDE.mdは結合される**
   - すべて読み込まれる
   - 同じ項目は上位が優先

3. **settings.jsonは上書きされる**
   - 配列は結合される
   - 同じキーは上位が優先

4. **適切な使い分け**
   - グローバル: 個人の基本スタイル
   - プロジェクト: チーム共有設定
   - ローカル: 個人の実験的設定

### ベストプラクティス

1. **グローバル設定は最小限に**
   - 本当に共通の設定のみ
   - プロジェクト固有は避ける

2. **プロジェクト設定はチームで合意**
   - レビューを通す
   - 理由を文書化

3. **ローカル設定は.gitignore**
   - チームに影響を与えない
   - 実験的な設定に活用

4. **定期的な見直し**
   - 不要な設定を削除
   - 矛盾を解消

### 次のステップ

これで第4章「メモリシステムの理解」は完了です。次の第5章「効果的なワークフロー」では、これらのメモリシステムを活用した実践的な開発フローを学びます。
