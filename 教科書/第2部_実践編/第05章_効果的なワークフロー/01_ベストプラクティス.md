# 01. ベストプラクティス

## この章で学ぶこと

Anthropic公式のベストプラクティスと、実践的な開発フローを学びます。探索・計画・実装・コミットの4段階アプローチを習得することで、Claude Codeを最大限に活用できるようになります。

## Anthropic公式ベストプラクティスの概要

Anthropicが推奨する開発アプローチは、以下の4つのフェーズで構成されています。

### 4段階の開発フロー

```
1. 探索 (Explore)
   ↓
2. 計画 (Plan)
   ↓
3. 実装 (Implement)
   ↓
4. コミット (Commit)
```

この順序で進めることで、効率的かつ高品質な開発が可能になります。

## フェーズ1: 探索 (Explore)

### 目的

実装前に、関連するコードベースを理解し、必要な情報を収集します。

### 基本的なアプローチ

```bash
# 関連ファイルを読み込ませる
> 以下のファイルを読み込んで、現在のアーキテクチャを教えてください:
  - src/components/UserProfile.tsx
  - src/hooks/useUser.ts
  - src/types/user.ts
```

### サブエージェントを活用した探索

複雑な問題では、サブエージェントに詳細調査を任せます。

```bash
> ユーザー認証の実装方法を調査してください。
  関連ファイルを読み込んで実装方針を立ててください。
  技術的に不明な点があれば、サブエージェントを使って詳しく調査してください。
```

**メリット**:
- メインのコンテキストを汚染しない
- 独立した視点で調査できる
- より深い技術調査が可能

### 探索のベストプラクティス

1. **まず全体像を把握**
```bash
> プロジェクトの構造を教えてください
> 主要なコンポーネントは何ですか？
```

2. **関連ファイルを特定**
```bash
> ユーザー認証に関連するファイルをリストアップしてください
```

3. **依存関係を理解**
```bash
> UserProfileコンポーネントが依存しているモジュールを教えてください
```

4. **既存のパターンを学習**
```bash
> 既存のAPIエンドポイントの実装パターンを分析してください
```

## フェーズ2: 計画 (Plan)

### 目的

実装前に明確な計画を立て、方向性を定めます。

### Plan Modeの活用

```bash
# Plan Modeに切り替え（Shift+Tab を2回）
> 以下の機能を実装したいです。実装計画を立ててください:
  - ユーザープロフィール編集機能
  - 画像アップロード
  - バリデーション
```

### Think機能の活用

より深く考えさせる場合は、thinkキーワードを使用します。

```bash
> この機能の実装方針を提案してください think

# さらに深く考えさせる
> セキュリティも考慮して再度検討してください ultrathink
```

**Think レベル**:
- `think` - 基本的な思考
- `think hard` - より深い思考
- `think harder` - さらに深い思考
- `ultrathink` - 最大限の思考

### 計画のベストプラクティス

1. **要件を明確にする**
```bash
> 以下の要件で実装計画を立ててください:
  要件:
  - ユーザーはプロフィール画像を変更できる
  - 画像サイズは5MB以下
  - 対応形式: JPG, PNG
  - 画像は自動的にリサイズされる
```

2. **技術的な制約を確認**
```bash
> 以下の制約を考慮してください:
  - Next.js App Router を使用
  - Cloudinaryで画像を保存
  - TypeScriptで型安全に
```

3. **実装順序を決定**
```bash
> 実装の順序を提案してください。
  テスト駆動開発で進めたいです。
```

4. **潜在的な問題を特定**
```bash
> この実装で起こりうる問題点を教えてください think
```

## フェーズ3: 実装 (Implement)

### 目的

計画に基づいて、実際のコードを実装します。

### テスト駆動開発 (TDD) アプローチ

**推奨フロー**:

```bash
# ステップ1: テストを先に書く
> UserProfileコンポーネントのテストを書いてください。
  以下の動作をテストします:
  - プロフィール画像の表示
  - 編集ボタンのクリック
  - フォーム送信
```

```bash
# ステップ2: テストの失敗を確認
> テストを実行してください
> npm test UserProfile.test.tsx
```

```bash
# ステップ3: テストをコミット
> テストファイルをgit addしてください
```

```bash
# ステップ4: 実装を書く
> テストが通るように実装してください
```

```bash
# ステップ5: テストの成功を確認
> テストを再実行してください
```

```bash
# ステップ6: 実装をコミット
> 実装をgit addして、適切なコミットメッセージでコミットしてください
```

### ビジュアルモックを使った開発

UIを作る場合は、デザインモックを活用します。

```bash
# デザイン画像をドラッグ&ドロップまたはCtrl+V (macOS) で貼り付け

> この画像のデザインに基づいて、UserProfileコンポーネントを実装してください。
  技術スタック:
  - React 18
  - TypeScript
  - Tailwind CSS
```

### 段階的な実装

大きな機能は小さく分割して実装します。

```bash
# ステップ1: 基本構造
> まずUserProfileコンポーネントの基本構造だけを作成してください

# ステップ2: データフェッチ
> ユーザーデータを取得する機能を追加してください

# ステップ3: 編集機能
> プロフィール編集機能を追加してください

# ステップ4: バリデーション
> フォームバリデーションを追加してください
```

### 実装のベストプラクティス

1. **明確な指示を出す**
```bash
# ❌ 悪い例
> プロフィール画面を作って

# ✅ 良い例
> UserProfileコンポーネントを作成してください。
  要件:
  - src/components/UserProfile.tsxに作成
  - PropsはUserProfile型を使用
  - Tailwind CSSでスタイリング
  - レスポンシブデザイン対応
```

2. **既存のパターンに従う**
```bash
> 既存のButtonコンポーネントと同じパターンで
  UserAvatarコンポーネントを作成してください
```

3. **型安全性を確保**
```bash
> TypeScript strict モードでエラーが出ないように実装してください
> 実装後に型チェックを実行してください: npm run typecheck
```

4. **即座にフィードバック**

間違った方向に進み始めたら、すぐに止めます。

```bash
# Escキーで即座に停止

> 待ってください。その実装方法ではなく、
  Reactの公式ドキュメントで推奨されている方法で実装してください
```

## フェーズ4: コミット (Commit)

### 目的

変更を適切にバージョン管理し、履歴を残します。

### コミットのタイミング

1. **テストを書いた時**
2. **機能が完成した時**
3. **リファクタリング後**
4. **バグ修正後**

### コミットの実践

```bash
# ステップ1: 変更内容を確認
> git statusとgit diffを実行して、変更内容を確認してください

# ステップ2: コミットメッセージを考える
> これまでの変更内容から、適切なコミットメッセージを提案してください。
  Conventional Commits 形式で。

# ステップ3: ステージングとコミット
> 以下のファイルをgit addして、提案したメッセージでコミットしてください:
  - src/components/UserProfile.tsx
  - src/components/UserProfile.test.tsx
  - src/types/user.ts

# ステップ4: 確認
> git logで最新のコミットを確認してください
```

### Conventional Commits形式

```bash
# フォーマット
<type>(<scope>): <subject>

# 例
feat(user): add profile edit functionality
fix(auth): correct token validation logic
docs(readme): update installation instructions
refactor(api): simplify error handling
test(user): add profile component tests
```

**主なタイプ**:
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント
- `refactor`: リファクタリング
- `test`: テスト追加
- `chore`: その他の変更

## 完全な実装フローの例

### 例: ユーザープロフィール編集機能の実装

**ステップ1: 探索**
```bash
> 以下を確認してください:
  1. 既存のユーザー関連コンポーネント
  2. 認証の実装方法
  3. APIエンドポイントの構造
  4. 使用しているバリデーションライブラリ
```

**ステップ2: 計画**
```bash
# Plan Modeに切り替え

> プロフィール編集機能の実装計画を立ててください think

  要件:
  - 名前、メールアドレス、プロフィール画像を編集可能
  - バリデーション必須
  - 画像は5MB以下
  - 編集中は他のページに移動できない（確認ダイアログ）

  制約:
  - Next.js App Router
  - React Hook Form + Zod
  - Tailwind CSS
  - tRPC で API 通信
```

**ステップ3: 実装（TDD）**
```bash
# 3-1: テストを書く
> UserProfileEdit.test.tsx を作成してください。
  以下の動作をテストします:
  - フォームの表示
  - 各フィールドの入力
  - バリデーションエラーの表示
  - 送信処理
  - ローディング状態

# 3-2: テストをコミット
> テストファイルをgit addしてコミットしてください
  コミットメッセージ: test(user): add profile edit tests

# 3-3: 実装を書く
> テストが通るように UserProfileEdit.tsx を実装してください

# 3-4: 型チェックとテスト
> 以下を実行してください:
  - npm run typecheck
  - npm test UserProfileEdit

# 3-5: 実装をコミット
> 実装をコミットしてください
  コミットメッセージ: feat(user): add profile edit functionality
```

**ステップ4: レビュー**
```bash
# 4-1: サブエージェントでレビュー
> サブエージェントを使って、以下の観点で実装をレビューしてください:
  - セキュリティ
  - パフォーマンス
  - アクセシビリティ
  - テストカバレッジ

# 4-2: 指摘事項の修正
> レビューで指摘された点を修正してください

# 4-3: 修正をコミット
> 修正をコミットしてください
  コミットメッセージ: refactor(user): improve profile edit security
```

## 長時間セッションの管理

### チェックリストの活用

大量のタスクがある場合は、チェックリストで管理します。

```bash
> 以下のlintエラーをすべてchecklist.mdに書き出してください

> 一つずつ修正して、完了したらチェックを入れてください

> 10個修正したら進捗を報告してください
```

### 重要な決定事項の記録

```bash
> 今回の実装方針をimplementation_notes.mdにまとめてください。
  以下の内容を含めてください:
  - 採用した技術とその理由
  - 断念した代替案
  - 今後の改善案

> /clearして次のタスクに進んでください
```

## よくあるアンチパターン

### ❌ アンチパターン1: いきなり実装

```bash
# 悪い例
> ユーザー認証機能を作って
```

**問題点**:
- 既存コードとの整合性が取れない
- 方針が定まっていない
- テストがない

**改善策**:
探索 → 計画 → 実装の順序を守る

### ❌ アンチパターン2: 長すぎる指示

```bash
# 悪い例
> ユーザーがログインできるような機能を作ってほしいんだけど、
  メールアドレスとパスワードで認証できるようにして、
  あと、パスワードを忘れた時の機能もあったほうがいいと思うし...
  （さらに続く）
```

**問題点**:
- 要点が不明確
- トークンの無駄遣い
- Claude Codeが混乱する

**改善策**:
簡潔で構造化された指示を出す

### ❌ アンチパターン3: コンテキストの放置

```bash
# 長時間作業を続けて、コンテキストが肥大化
# /clearも/compactも使わない
```

**問題点**:
- 応答精度が下がる
- トークン消費が増える
- 関係ない情報が混ざる

**改善策**:
定期的に/clearまたは/compactを実行

### ❌ アンチパターン4: 曖昧なフィードバック

```bash
# 悪い例
> それは違う

# 良い例
> その実装方法ではなく、React Hooksを使った方法で実装してください。
  特にuseStateとuseEffectを活用してください。
```

**改善策**:
具体的で明確なフィードバックを提供

## まとめ

### 4段階フローの重要性

1. **探索**: 理解してから始める
2. **計画**: 方針を定める
3. **実装**: 段階的に進める
4. **コミット**: 履歴を残す

### ベストプラクティスのチェックリスト

- [ ] 実装前に関連ファイルを確認
- [ ] Plan Modeで計画を立てる
- [ ] 複雑な調査はサブエージェントに任せる
- [ ] テストを先に書く（TDD）
- [ ] 段階的に実装する
- [ ] 即座にフィードバックする
- [ ] 定期的に/clearまたは/compactを実行
- [ ] 適切なタイミングでコミット
- [ ] Conventional Commits形式を使用
- [ ] 重要な決定事項を記録

### 次のステップ

次の章では、コンテキスト管理の詳細なテクニックを学びます。/clear、/compactの使い分け、長時間セッションの管理方法など、さらに実践的なスキルを習得します。
