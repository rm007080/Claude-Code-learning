# 04. トラブルシューティング

## 問題診断フローチャート

```
スクリーンショット/クリップボード問題
│
├─ テキストコピーは動作するか？
│  │
│  ├─ YES → 画像固有の問題（セクションB）
│  │
│  └─ NO → クリップボード統合の問題（セクションA）
│
└─ WSL2は正常に起動しているか？
   │
   ├─ YES → 環境設定の問題（セクションC）
   │
   └─ NO → WSL2自体の問題（セクションD）
```

## セクションA: クリップボード統合の問題

### A-1: テキストコピーが動作しない

#### 症状
```bash
echo "test" | wl-copy
# エラー: Failed to connect to Wayland server
```

#### 原因と解決策

**原因1: WAYLAND_DISPLAY環境変数が未設定**

```bash
# 確認
echo $WAYLAND_DISPLAY
# 空の場合は設定が必要

# 一時的に設定
export WAYLAND_DISPLAY=wayland-0

# 恒久的に設定
echo 'export WAYLAND_DISPLAY=wayland-0' >> ~/.bashrc
source ~/.bashrc

# テスト
echo "テスト" | wl-copy && wl-paste
```

**原因2: Waylandソケットが存在しない**

```bash
# ソケットの確認
ls -la /mnt/wslg/runtime-dir/

# ソケットが存在する場合、シンボリックリンクを作成
ln -sf /mnt/wslg/runtime-dir/wayland-0 $XDG_RUNTIME_DIR/wayland-0
ln -sf /mnt/wslg/runtime-dir/wayland-0.lock $XDG_RUNTIME_DIR/wayland-0.lock

# XDG_RUNTIME_DIRが未設定の場合
if [ -z "$XDG_RUNTIME_DIR" ]; then
    export XDG_RUNTIME_DIR=/run/user/$(id -u)
    echo 'export XDG_RUNTIME_DIR=/run/user/$(id -u)' >> ~/.bashrc
fi
```

**原因3: WSLgが無効になっている**

```powershell
# PowerShellで確認（Windows側）
wsl --version

# WSLgバージョンが表示されない場合、WSLを更新
wsl --update

# WSLを再起動
wsl --shutdown
wsl
```

### A-2: xclipが動作しない（Windows 10）

#### 症状
```bash
echo "test" | xclip -selection clipboard
# エラー: cannot open display
```

#### 解決策

**Step 1: DISPLAY環境変数の設定**

```bash
# ホストIPを取得
export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}'):0

# 確認
echo $DISPLAY
# 出力例: 172.28.160.1:0

# 恒久的に設定
cat >> ~/.bashrc << 'EOF'
export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}'):0
EOF

source ~/.bashrc
```

**Step 2: VcXsrvの起動確認**

```powershell
# PowerShellでプロセス確認（Windows側）
Get-Process vcxsrv

# 起動していない場合、VcXsrvを起動
# XLaunch.exeを実行
```

**Step 3: ファイアウォール設定**

```
1. Windows Defenderファイアウォールを開く
2. 「アプリをファイアウォール経由で通信させる」
3. VcXsrvを探し、プライベートとパブリック両方にチェック
4. WSLを再起動
```

**Step 4: 接続テスト**

```bash
# X11動作テスト
xeyes &

# 目のアイコンが表示されればX11接続成功
# Ctrl+Cで終了
```

## セクションB: 画像固有の問題

### B-1: 画像が直接貼り付けられない

#### 症状
```
Win+Shift+S → Claude CodeでCtrl+V → 画像が表示されない
```

#### 説明
これは**仕様上の制限**です。Claude Codeはクリップボードからの画像バイナリデータの直接読み込みに対応していません。

#### 回避策

**方法1: ファイルパスを指定（推奨）**
```bash
# スクリーンショットをファイルとして保存
# Win+Shift+S → Ctrl+S

# Claude Codeで指定
"""
この画像を分析してください:
C:\Users\username\Pictures\screenshot.png
"""

# CLAUDE.md設定後は自動的に変換される
# → /mnt/c/Users/username/Pictures/screenshot.png
```

**方法2: 自動ファイル化スクリプト**
```bash
# clipimgエイリアスを使用（事前設定が必要）
clipimg

# 出力されたパスをClaude Codeに貼り付け
```

**方法3: ドラッグ&ドロップ**
```
Windowsエクスプローラーから画像ファイルを
Claude Codeの入力欄に直接ドラッグ
```

### B-2: パス変換が機能しない

#### 症状
```bash
# Claude Codeに以下を入力
"""
この画像を見てください: C:\Users\username\Pictures\test.png
"""

# エラー: No such file or directory
```

#### 解決策

**Step 1: CLAUDE.mdの存在確認**

```bash
# プロジェクトルートで確認
ls -la CLAUDE.md

# 存在しない場合は作成
nano CLAUDE.md
```

**Step 2: CLAUDE.mdの内容確認**

```bash
# パス変換ルールが含まれているか確認
cat CLAUDE.md | grep -i "windows"
cat CLAUDE.md | grep -i "mnt"

# 含まれていない場合、追加する（第03章参照）
```

**Step 3: Claude Codeの再起動**

```bash
# Claude Codeを完全に終了
# （ターミナルを閉じるだけでなく、プロセスを終了）

# 再起動後、設定が反映される
```

**Step 4: 手動でパス変換してテスト**

```bash
# まず手動で変換したパスで動作確認
# C:\Users\username\Pictures\test.png
# ↓
# /mnt/c/Users/username/Pictures/test.png

# ファイルが存在するか確認
ls -la /mnt/c/Users/username/Pictures/test.png

# 存在する場合、CLAUDE.md設定の問題
# 存在しない場合、ファイルパス自体が間違っている
```

### B-3: 日本語ファイル名が文字化けする

#### 症状
```bash
ls /mnt/c/Users/username/Pictures/
# スクリーンショット_20251113.png が正しく表示されない
```

#### 解決策

```bash
# ロケールの確認
locale

# UTF-8に設定
export LANG=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8

# 恒久的に設定
cat >> ~/.bashrc << 'EOF'
export LANG=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8
EOF

source ~/.bashrc

# 日本語ロケールパッケージのインストール（必要な場合）
sudo apt install language-pack-ja -y
sudo update-locale LANG=ja_JP.UTF-8
```

## セクションC: 環境設定の問題

### C-1: WSL2が起動しない

#### 症状
```powershell
wsl
# エラー: WSL 2 には、カーネル コンポーネントの更新が必要です
```

#### 解決策

```powershell
# WSLの更新
wsl --update

# Linuxカーネル更新パッケージをインストール
# https://aka.ms/wsl2kernel からダウンロード

# WSLバージョンの確認
wsl --version

# デフォルトバージョンをWSL2に設定
wsl --set-default-version 2

# 既存のディストリビューションをWSL2に変換
wsl --set-version Ubuntu 2
```

### C-2: 環境変数が再起動後に消える

#### 症状
```bash
# 設定したはずの環境変数が消えている
echo $DISPLAY
# 空
```

#### 解決策

```bash
# ~/.bashrcに正しく追加されているか確認
cat ~/.bashrc | grep DISPLAY

# 追加されていない場合は追加
cat >> ~/.bashrc << 'EOF'
# WSL2クリップボード設定
export DISPLAY=:0
export WAYLAND_DISPLAY=wayland-0
export XDG_RUNTIME_DIR=/run/user/$(id -u)
EOF

# .bashrcが読み込まれているか確認
echo $BASH_SOURCE

# .profileや.bash_profileで上書きされていないか確認
grep -i display ~/.profile ~/.bash_profile

# 強制的に読み込むようにする
echo 'source ~/.bashrc' >> ~/.bash_profile
```

### C-3: 権限エラー

#### 症状
```bash
ln -sf /mnt/wslg/runtime-dir/wayland-0 $XDG_RUNTIME_DIR/
# Permission denied
```

#### 解決策

```bash
# XDG_RUNTIME_DIRの権限確認
ls -ld $XDG_RUNTIME_DIR

# 権限が正しくない場合、修正
sudo chown -R $USER:$USER $XDG_RUNTIME_DIR
sudo chmod 700 $XDG_RUNTIME_DIR

# 再度シンボリックリンク作成
ln -sf /mnt/wslg/runtime-dir/wayland-0 $XDG_RUNTIME_DIR/

# それでも失敗する場合、既存のリンクを削除
rm -f $XDG_RUNTIME_DIR/wayland-0
ln -sf /mnt/wslg/runtime-dir/wayland-0 $XDG_RUNTIME_DIR/
```

## セクションD: WSL2自体の問題

### D-1: WSL2が完全にクラッシュした

#### 解決策

```powershell
# PowerShellで実行（管理者権限）

# 1. WSLを完全にシャットダウン
wsl --shutdown

# 2. WSLサービスを再起動
# サービス管理ツールで「LxssManager」を再起動

# 3. Windowsを再起動（最終手段）

# 4. WSLを起動
wsl

# 5. 動作確認
wsl --list --verbose
```

### D-2: ディストリビューションが破損した

#### 解決策

```powershell
# バックアップ（可能な場合）
wsl --export Ubuntu C:\backup\ubuntu.tar

# ディストリビューションをアンインストール
wsl --unregister Ubuntu

# 再インストール
# Microsoft Storeから再度インストール

# バックアップから復元
wsl --import Ubuntu C:\WSL\Ubuntu C:\backup\ubuntu.tar
```

## 診断スクリプト

### 包括的な診断スクリプト

```bash
#!/bin/bash
# wsl_clipboard_diagnosis.sh

echo "========================================="
echo "WSL2クリップボード統合診断スクリプト"
echo "========================================="
echo ""

# WSL環境確認
echo "[1] WSL環境確認"
uname -a
echo ""

# パッケージ確認
echo "[2] クリップボードツール確認"
echo -n "wl-copy: "
which wl-copy && echo "✓ インストール済み" || echo "✗ 未インストール"
echo -n "xclip: "
which xclip && echo "✓ インストール済み" || echo "✗ 未インストール"
echo ""

# 環境変数確認
echo "[3] 環境変数確認"
echo "DISPLAY: $DISPLAY"
echo "WAYLAND_DISPLAY: $WAYLAND_DISPLAY"
echo "XDG_RUNTIME_DIR: $XDG_RUNTIME_DIR"
echo ""

# Waylandソケット確認
echo "[4] Waylandソケット確認"
if [ -e "/mnt/wslg/runtime-dir/wayland-0" ]; then
    echo "✓ Waylandソケット存在"
    ls -la /mnt/wslg/runtime-dir/wayland-0
else
    echo "✗ Waylandソケット不在"
fi
echo ""

# XDG_RUNTIME_DIR内のシンボリックリンク確認
echo "[5] シンボリックリンク確認"
if [ -L "$XDG_RUNTIME_DIR/wayland-0" ]; then
    echo "✓ シンボリックリンク存在"
    ls -la $XDG_RUNTIME_DIR/wayland-0
else
    echo "✗ シンボリックリンク不在"
fi
echo ""

# wl-clipboard動作テスト
echo "[6] wl-clipboard動作テスト"
if which wl-copy > /dev/null; then
    echo "診断テスト" | wl-copy 2>&1
    if [ $? -eq 0 ]; then
        echo "✓ wl-copy動作成功"
        result=$(wl-paste)
        if [ "$result" = "診断テスト" ]; then
            echo "✓ wl-paste動作成功"
        else
            echo "✗ wl-paste動作失敗"
        fi
    else
        echo "✗ wl-copy動作失敗"
    fi
else
    echo "- wl-clipboard未インストール"
fi
echo ""

# CLAUDE.md確認
echo "[7] CLAUDE.md確認"
if [ -f "CLAUDE.md" ]; then
    echo "✓ CLAUDE.md存在"
    if grep -q "Windows" CLAUDE.md; then
        echo "✓ パス変換ルール設定済み"
    else
        echo "! パス変換ルール未設定（推奨）"
    fi
else
    echo "! CLAUDE.md不在（必要に応じて作成）"
fi
echo ""

echo "========================================="
echo "診断完了"
echo "========================================="
```

### 使用方法

```bash
# スクリプトを保存
nano ~/wsl_clipboard_diagnosis.sh

# 実行権限を付与
chmod +x ~/wsl_clipboard_diagnosis.sh

# 実行
~/wsl_clipboard_diagnosis.sh
```

## よくあるエラーメッセージと対処法

### エラー: "cannot open display: :0"
```bash
# 対処: DISPLAY環境変数を再設定
export DISPLAY=:0
source ~/.bashrc
```

### エラー: "Failed to connect to Wayland server"
```bash
# 対処: Waylandソケットのシンボリックリンクを作成
ln -sf /mnt/wslg/runtime-dir/wayland-0 $XDG_RUNTIME_DIR/
```

### エラー: "XDG_RUNTIME_DIR not set"
```bash
# 対処: XDG_RUNTIME_DIRを設定
export XDG_RUNTIME_DIR=/run/user/$(id -u)
echo 'export XDG_RUNTIME_DIR=/run/user/$(id -u)' >> ~/.bashrc
```

### エラー: "wl-copy: command not found"
```bash
# 対処: wl-clipboardをインストール
sudo apt update
sudo apt install wl-clipboard -y
```

## まとめ

- 問題はクリップボード統合、画像処理、環境設定、WSL2本体の4カテゴリに分類
- テキストコピーの動作確認が最初の診断ポイント
- 環境変数とシンボリックリンクの設定が重要
- 診断スクリプトで包括的な確認が可能
- ほとんどの問題は環境変数の再設定やパッケージの再インストールで解決

第10章の学習お疲れ様でした。次は付録で、実用的なテンプレートとFAQを確認しましょう。
