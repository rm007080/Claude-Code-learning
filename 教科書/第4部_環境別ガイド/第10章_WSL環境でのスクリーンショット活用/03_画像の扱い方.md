# 03. 画像の扱い方

## Claude Codeにおける画像利用の制限事項

### クリップボードからの直接貼り付けの制限

Claude Codeでは、現状X11/Waylandレベルでのバイナリ画像データの直接読み込みに対応していません。

**制限内容:**
```bash
# ❌ 動作しない方法
1. Win+Shift+Sでスクリーンショット撮影
2. Ctrl+VでClaude Codeに直接貼り付け
→ 画像が認識されない
```

**なぜ制限があるのか:**
- クリップボードのテキストデータは転送可能
- しかし、バイナリ画像データの転送機構が未実装
- WSL2とWindows間のデータフォーマット変換の問題

## 推奨される画像利用方法

### 方法1: ファイルパス指定（最も推奨）

#### Windows形式のパスを指定

```bash
# Claude Codeへの指示例
"""
この画像のエラーメッセージを解析してください:
C:\Users\username\Pictures\screenshot.png
"""
```

#### パス変換の仕組み

```
Windowsパス:
C:\Users\username\Pictures\screenshot.png

↓ 自動変換（CLAUDE.md設定後）

WSL2パス:
/mnt/c/Users/username/Pictures/screenshot.png
```

**変換ルール:**
```
C:\ → /mnt/c/
D:\ → /mnt/d/
\ (バックスラッシュ) → / (スラッシュ)
```

### 方法2: ドラッグ&ドロップ

```
1. Windowsエクスプローラーで画像ファイルを表示
2. Claude Codeの入力欄に直接ドラッグ
3. 自動的に [Image #1] の形式で挿入される
```

**メリット:**
- パスを手入力する必要がない
- 複数画像を同時に添付可能
- 直感的な操作

**デメリット:**
- ターミナル環境によっては未対応の場合がある
- リモート接続時は動作しない可能性

### 方法3: PowerShellスクリプトで自動ファイル化（上級者向け）

#### スクリプトの作成

```powershell
# C:\Users\username\clipboard_to_file.ps1 として保存

Add-Type -AssemblyName System.Windows.Forms
$img = [System.Windows.Forms.Clipboard]::GetImage()

if ($img) {
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $path = "C:\Users\$env:USERNAME\Pictures\claude_screenshots\clipboard_$timestamp.png"

    # ディレクトリが存在しない場合は作成
    $dir = Split-Path $path
    if (!(Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir | Out-Null
    }

    $img.Save($path, [System.Drawing.Imaging.ImageFormat]::Png)
    Write-Output $path
} else {
    Write-Output "クリップボードに画像がありません"
}
```

#### WSL側でのエイリアス設定

```bash
# ~/.bashrcに以下を追加
alias clipimg='powershell.exe -ExecutionPolicy Bypass -File /mnt/c/Users/username/clipboard_to_file.ps1'

# 設定を反映
source ~/.bashrc
```

#### 使用方法

```bash
# 1. Win+Shift+Sでスクリーンショット撮影

# 2. WSLターミナルで実行
clipimg

# 出力例:
# C:\Users\username\Pictures\claude_screenshots\clipboard_20251113_143022.png

# 3. 出力されたパスをClaude Codeで使用
# （CLAUDE.md設定済みの場合、自動変換される）
```

### 方法4: VS Code/Cursor拡張機能（Paste Image）

#### インストール手順

```bash
# VS CodeまたはCursorで
1. 拡張機能マーケットプレイスを開く（Ctrl+Shift+X）
2. "Paste Image"で検索
3. "Paste Image" by mushan をインストール
```

#### 設定

```json
// settings.json に追加
{
    "pasteImage.path": "${projectRoot}/screenshots",
    "pasteImage.basePath": "${projectRoot}",
    "pasteImage.forceUnixStyleSeparator": true,
    "pasteImage.prefix": "/",
    "pasteImage.showFilePathConfirmInputBox": true
}
```

#### 使用方法

```
1. Win+Shift+Sでスクリーンショット撮影
2. VS Code/Cursorのエディタ上でCtrl+Alt+V
3. ファイル名を入力（デフォルト: タイムスタンプ）
4. 画像が自動保存され、パスがエディタに挿入される
```

## CLAUDE.mdでの自動パス変換設定

### CLAUDE.mdファイルの作成

```bash
# プロジェクトルートで実行
nano CLAUDE.md
```

### 設定内容

```markdown
# Claude Code Configuration

## MUST - Critical Rules
- MUST WindowsのパスはWSL2のマウントパスに変換すること
- 例: "C:\Users\user1\Pictures\test.jpg" → "/mnt/c/Users/user1/Pictures/test.jpg"
- 例: "C:\workspace\project" → "/mnt/c/workspace/project"
- 例: "D:\Data\image.png" → "/mnt/d/Data/image.png"

## Path Conversion Rule
- Windows Drive Letter: C: → /mnt/c/
- Windows Drive Letter: D: → /mnt/d/
- Windows Drive Letter: E: → /mnt/e/
- Backslash: \ → Forward Slash: /
- Case-insensitive: Windows paths are case-insensitive, WSL paths are case-sensitive

## Image File Handling
- When user provides Windows path to an image, automatically convert to WSL2 mount path
- Always use absolute paths for file references
- Verify file existence before processing: test -f "/mnt/c/path/to/file"

## Important Notes
- Always use WSL-compatible paths when referencing files
- Do not mix Windows and WSL paths in the same command
- When providing file paths to the user, convert them to WSL format
- Handle spaces in paths by using quotes: "/mnt/c/Program Files/..."

## Example Commands
### Correct
```bash
# 画像ファイルの確認
ls -lh "/mnt/c/Users/username/Pictures/screenshot.png"

# 画像をプロジェクトにコピー
cp "/mnt/c/Users/username/Pictures/screenshot.png" ./images/

# 画像サイズ確認
file "/mnt/c/Users/username/Pictures/screenshot.png"
```

### Incorrect
```bash
# ❌ Windowsパスをそのまま使用
ls -lh "C:\Users\username\Pictures\screenshot.png"

# ❌ バックスラッシュを使用
cp C:\Users\username\Pictures\screenshot.png ./images/
```

## Troubleshooting
- If file not found, check if drive letter is correctly mounted
- Verify /mnt/c/ exists: ls /mnt/
- Check file permissions: ls -la "/mnt/c/..."
```

### 設定の反映

```bash
# 1. CLAUDE.mdを保存

# 2. Claude Codeを完全に終了

# 3. Claude Codeを再起動

# 4. 新しいルールが有効化される
```

### 動作確認

```bash
# Claude Codeで以下のように入力
"""
この画像を分析してください: C:\Users\username\Pictures\test.png
"""

# Claude Codeが自動的に以下のように解釈
# → /mnt/c/Users/username/Pictures/test.png

# ファイルの存在確認も自動実行
# test -f "/mnt/c/Users/username/Pictures/test.png"
```

## パス変換のベストプラクティス

### 1. 一貫性のあるディレクトリ構造

```bash
# 推奨: 専用ディレクトリを作成
mkdir -p ~/claude-images

# Windowsから見た場合
# \\wsl$\Ubuntu\home\username\claude-images\

# シンボリックリンクを作成（オプション）
ln -s /mnt/c/Users/username/Pictures ~/pictures-win
```

### 2. スクリーンショット専用フォルダ

```powershell
# Windows側で専用フォルダを作成
New-Item -Path "C:\ClaudeScreenshots" -ItemType Directory

# WSL側からアクセス
ls /mnt/c/ClaudeScreenshots/
```

### 3. 自動変換スクリプト

```bash
# ~/bin/win2wsl.sh として保存
#!/bin/bash

# Windowsパスをコマンドライン引数として受け取り、WSLパスに変換
if [ -z "$1" ]; then
    echo "使用法: win2wsl.sh 'C:\path\to\file'"
    exit 1
fi

# 変換処理
wsl_path=$(echo "$1" | sed 's/\\/\//g' | sed 's/C:/\/mnt\/c/g' | sed 's/D:/\/mnt\/d/g')
echo "$wsl_path"
```

```bash
# 実行権限を付与
chmod +x ~/bin/win2wsl.sh

# 使用例
~/bin/win2wsl.sh "C:\Users\username\Pictures\test.png"
# 出力: /mnt/c/Users/username/Pictures/test.png
```

## よくある問題と解決策

### 問題1: 日本語ファイル名が文字化けする

**解決策:**
```bash
# ロケール設定を確認
locale

# UTF-8に設定
export LANG=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8

# 恒久的に設定
echo 'export LANG=ja_JP.UTF-8' >> ~/.bashrc
```

### 問題2: スペースを含むパス

**解決策:**
```bash
# ✓ 正しい方法（クォートで囲む）
ls "/mnt/c/Program Files/Screenshot/image.png"

# ✓ または、エスケープする
ls /mnt/c/Program\ Files/Screenshot/image.png

# ❌ 間違い
ls /mnt/c/Program Files/Screenshot/image.png
```

### 問題3: ファイルが見つからない

**確認手順:**
```bash
# 1. マウントポイントの確認
mount | grep /mnt/c

# 2. ドライブレターの確認
ls /mnt/

# 3. パス全体を順に確認
ls /mnt/c/
ls /mnt/c/Users/
ls /mnt/c/Users/username/
ls /mnt/c/Users/username/Pictures/

# 4. ファイルの存在確認
test -f "/mnt/c/Users/username/Pictures/test.png" && echo "存在する" || echo "存在しない"
```

## まとめ

- Claude Codeでは画像の直接貼り付けは未対応
- ファイルパス指定が最も確実な方法
- CLAUDE.mdでWindowsパスを自動変換可能
- PowerShellスクリプトやVS Code拡張機能で効率化
- パスにはスペースや日本語文字に注意

次章では、よくあるトラブルとその解決方法を詳しく解説します。
