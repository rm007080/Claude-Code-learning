# ワークフローファイルの作成

## はじめに

この章では、Claude Code Actionを実行するためのワークフローファイルを作成します。`.github/workflows/claude.yml` ファイルを正しく設定することで、GitHub上で `@claude` メンションが動作するようになります。

## ワークフローファイルとは

### GitHub Actionsの基本

**GitHub Actions**は、GitHubリポジトリでCI/CDやタスク自動化を実現する仕組みです。

**ワークフローファイル:**
- `.github/workflows/` ディレクトリに配置
- YAML形式で記述
- イベント（トリガー）、ジョブ、ステップを定義

## ディレクトリ構造

### 作成する構造

```
your-repository/
├── .github/
│   └── workflows/
│       └── claude.yml  ← このファイルを作成
├── src/
├── README.md
└── package.json
```

### 作成手順

#### ステップ1: ディレクトリの作成

**PowerShell（Windows推奨）:**
```powershell
# リポジトリのルートディレクトリで実行
New-Item -Path ".github\workflows" -ItemType Directory -Force
```

または:
```powershell
mkdir -Force .github/workflows
```

**Bash（macOS/Linux）:**
```bash
mkdir -p .github/workflows
```

**VSCode/Cursorでの作成:**
1. エクスプローラーで `.github` フォルダを右クリック
2. 「New Folder」→ `workflows`
3. 完了

#### ステップ2: ファイルの確認

```bash
# ディレクトリ構造を確認
ls -la .github/workflows/  # macOS/Linux
dir .github\workflows\      # PowerShell
```

## claude.ymlファイルの作成

### 基本的なワークフローファイル

`.github/workflows/claude.yml` を作成し、以下の内容を記述します。

```yaml
name: Claude Code Action

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  claude-response:
    # Only run on comments that start with @claude
    if: |
      (github.event.comment.body != null && startsWith(github.event.comment.body, '@claude')) ||
      (github.event.comment.body != null && contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest

    steps:
      # Checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          # Use OAuth token (for Pro/Max users)
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # GitHub token (automatically provided by GitHub Actions)
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Optional: Specify Claude model (defaults to claude-sonnet-4-20250514)
          # model: claude-sonnet-4-20250514

          # Optional: Maximum tokens for response
          # max_tokens: 4096
```

### ファイルの各要素の説明

#### 1. ワークフロー名

```yaml
name: Claude Code Action
```

GitHub Actionsの画面に表示される名前です。

#### 2. トリガー（on）

```yaml
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
```

**動作するイベント:**
- `issue_comment`: Issueにコメントが追加されたとき
- `pull_request_review_comment`: PRのレビューコメントが追加されたとき

#### 3. 権限（permissions）

```yaml
permissions:
  contents: write
  issues: write
  pull-requests: write
```

**必要な権限:**
- `contents: write` - コードの読み書き
- `issues: write` - Issue操作
- `pull-requests: write` - PR操作

#### 4. 実行条件（if）

```yaml
if: |
  (github.event.comment.body != null && startsWith(github.event.comment.body, '@claude')) ||
  (github.event.comment.body != null && contains(github.event.comment.body, '@claude'))
```

**条件:**
- コメントが `@claude` で始まる
- または、コメントに `@claude` が含まれる

これにより、`@claude` が含まれるコメントのみでワークフローが実行されます。

#### 5. 実行環境（runs-on）

```yaml
runs-on: ubuntu-latest
```

Ubuntu Linuxの最新版で実行されます。

#### 6. ステップ（steps）

**重要なステップ1: リポジトリのチェックアウト**

```yaml
- name: Checkout repository
  uses: actions/checkout@v4
```

**これは必須です！** これがないと `fatal: not a git repository` エラーが発生します。

**重要なステップ2: Claude Code Actionの実行**

```yaml
- name: Run Claude Code Action
  uses: anthropics/claude-code-action@v1
  with:
    claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
    github_token: ${{ secrets.GITHUB_TOKEN }}
```

**設定内容:**
- `claude_code_oauth_token` - 前章で設定したSecret
- `github_token` - GitHub Actionsが自動提供するトークン

### オプション設定

#### モデルの指定

```yaml
- name: Run Claude Code Action
  uses: anthropics/claude-code-action@v1
  with:
    claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
    github_token: ${{ secrets.GITHUB_TOKEN }}
    model: claude-sonnet-4-20250514  # 使用するモデルを明示
```

**利用可能なモデル:**
- `claude-sonnet-4-20250514` (デフォルト)
- `claude-opus-4-20250514` (より高性能、トークン消費多)

#### 最大トークン数の指定

```yaml
- name: Run Claude Code Action
  uses: anthropics/claude-code-action@v1
  with:
    claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
    github_token: ${{ secrets.GITHUB_TOKEN }}
    max_tokens: 8192  # デフォルトは4096
```

**推奨値:**
- 簡単な質問: 2048-4096
- 通常のタスク: 4096（デフォルト）
- 複雑な実装: 8192-16384

## GitHubへのプッシュ

### Git操作の手順

**ステップ1: 現在の状態を確認**

```bash
git status
```

**出力例:**
```
On branch main
Untracked files:
  .github/
```

**ステップ2: ファイルを追加**

```bash
git add .github/workflows/claude.yml
```

**ステップ3: コミット**

```bash
git commit -m "feat: Add Claude Code Action workflow"
```

**コミットメッセージの推奨形式:**
```
<type>: <description>

例:
feat: Add Claude Code Action workflow
fix: Add checkout step to workflow
docs: Add setup guide
```

**ステップ4: GitHubにプッシュ**

```bash
git push origin main
```

または、使用しているブランチ名に合わせて:
```bash
git push origin master
```

### プッシュ後の確認

**GitHubリポジトリのActionsページにアクセス:**
```
https://github.com/your-username/your-repo/actions
```

**確認内容:**
```
Workflows
  Claude Code Action  ✅ ← 表示されていればOK

Recent workflow runs
  (まだ実行されていない)
```

## よくある間違いと修正方法

### 間違い1: `actions/checkout@v4` がない

**症状:**
```
fatal: not a git repository (or any of the parent directories): .git
```

**原因:**
```yaml
steps:
  # これがない！
  - name: Run Claude Code Action
    uses: anthropics/claude-code-action@v1
```

**修正:**
```yaml
steps:
  # これを追加
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Run Claude Code Action
    uses: anthropics/claude-code-action@v1
```

### 間違い2: インデントが間違っている

**症状:** ワークフローが表示されない、またはYAMLパースエラー

**原因:** YAMLはインデントに厳格

**正しい例:**
```yaml
jobs:
  claude-response:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
```

**間違った例:**
```yaml
jobs:
claude-response:  # インデント不足
runs-on: ubuntu-latest  # インデント不足
```

### 間違い3: Secret名のスペルミス

**症状:** `CLAUDE_CODE_OAUTH_TOKEN not found`

**原因:**
```yaml
claude_code_oauth_token: ${{ secrets.CLAUDE_OAUTH_TOKEN }}  # 間違い
```

**修正:**
```yaml
claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}  # 正しい
```

## 高度な設定

### 特定のファイルパターンでのみ実行

```yaml
on:
  pull_request:
    paths:
      - 'src/**'
      - '**.ts'
      - '**.tsx'
  issue_comment:
    types: [created]
```

### 特定のブランチでのみ実行

```yaml
on:
  pull_request:
    branches:
      - main
      - develop
  issue_comment:
    types: [created]
```

### 並列実行の制限

```yaml
concurrency:
  group: claude-${{ github.ref }}
  cancel-in-progress: true
```

これにより、同じブランチで複数のワークフローが同時実行されるのを防ぎます。

## トラブルシューティング

### 問題: ワークフローが表示されない

**確認項目:**
- [ ] `.github/workflows/claude.yml` が存在するか
- [ ] ファイル名が正しいか（`.yml` 拡張子）
- [ ] YAMLの文法が正しいか
- [ ] GitHubにプッシュされているか

**YAMLの文法チェック:**
```
https://yaml-online-parser.appspot.com/
```

### 問題: ワークフローが実行されない

**確認項目:**
- [ ] `@claude` が含まれているか
- [ ] トリガー条件（`if`）が正しいか
- [ ] Claude GitHub Appがインストールされているか

## テンプレートとして保存

### 他のリポジトリでの再利用

このワークフローファイルをテンプレートとして保存しておくと、新しいリポジトリで簡単に使い回せます。

**保存場所:**
- ローカルのテンプレートフォルダ
- Gist（プライベート）
- ドキュメントリポジトリ

**使用方法:**
1. 新しいリポジトリで `.github/workflows/` を作成
2. `claude.yml` をコピー
3. git add, commit, push
4. Secretsを設定（`CLAUDE_CODE_OAUTH_TOKEN`）
5. 動作確認

## まとめ

### 完了したこと

- [x] `.github/workflows/` ディレクトリの作成
- [x] `claude.yml` ファイルの作成
- [x] 必須ステップ（`actions/checkout@v4`）の追加
- [x] GitHubへのプッシュ
- [x] ワークフローの確認

### 重要なポイント

1. **必須ステップ**: `actions/checkout@v4` は絶対に必要
2. **Secret名**: `CLAUDE_CODE_OAUTH_TOKEN` を正確に
3. **YAMLの文法**: インデントに注意
4. **トリガー条件**: `@claude` メンションで動作

### 次章の内容

次の章では、自動PRレビューの設定と活用方法を学びます。Pull Requestで `@claude` とメンションするだけで、自動的にコードレビューが実行されるようになります。
