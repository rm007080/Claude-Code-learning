# トラブルシューティング

## はじめに

この章では、Claude GitHub Actionのセットアップと運用で遭遇する可能性のあるエラーと、その解決方法を詳しく解説します。実際の設定記録から得られた知見を基に、確実に問題を解決できるようにガイドします。

## エラー1: `fatal: not a git repository`

### 症状

GitHub Actionsのログに以下のエラーが表示されます。

```
fatal: not a git repository (or any of the parent directories): .git

Error in branch setup:
ShellError: Failed with exit code 128
  exitCode: 128,
  stdout: "",
  stderr: "fatal: not a git repository (or any of the parent directories): .git\n"
```

### 原因

ワークフローファイルに **`actions/checkout@v4`** ステップが欠けています。

GitHub Actionsはデフォルトでリポジトリをチェックアウトしないため、Claude Code Actionがコードにアクセスできません。

### 解決策

ワークフローファイル（`.github/workflows/claude.yml`）に以下を追加します。

**修正前（誤り）:**
```yaml
steps:
  - name: Run Claude Code Action
    uses: anthropics/claude-code-action@v1
    # ...
```

**修正後（正しい）:**
```yaml
steps:
  # この行を追加！
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Run Claude Code Action
    uses: anthropics/claude-code-action@v1
    # ...
```

### 確認方法

1. `.github/workflows/claude.yml` を編集
2. `actions/checkout@v4` ステップを追加
3. git add, commit, push
4. GitHub Actionsで再実行

**正常な実行ログ:**
```
Run Checkout repository
  ✓ Checkout repository
  ✓ Run Claude Code Action
```

## エラー2: `CLAUDE_CODE_OAUTH_TOKEN not found`

### 症状

GitHub Actionsのログに以下のエラーが表示されます。

```
Error: Either ANTHROPIC_API_KEY or CLAUDE_CODE_OAUTH_TOKEN environment variable is required
```

または:
```
Error: CLAUDE_CODE_OAUTH_TOKEN not found
```

### 原因

#### 原因1: Secretが設定されていない

GitHub SecretsにOAuth Tokenが追加されていません。

#### 原因2: Secret名のスペルミス

ワークフローファイルでのSecret参照時に、名前が間違っています。

### 解決策

#### 解決策1: Secretの確認と追加

1. **GitHubのSecretsページにアクセス**
   ```
   https://github.com/your-username/your-repo/settings/secrets/actions
   ```

2. **Secretが存在するか確認**
   ```
   Repository secrets:
     CLAUDE_CODE_OAUTH_TOKEN    ← これが表示されるか？
   ```

3. **存在しない場合は追加**
   - 「New repository secret」をクリック
   - Name: `CLAUDE_CODE_OAUTH_TOKEN`
   - Secret: 生成したOAuth Token
   - 「Add secret」をクリック

#### 解決策2: ワークフローファイルの確認

**誤ったSecret名の例:**
```yaml
claude_code_oauth_token: ${{ secrets.CLAUDE_OAUTH_TOKEN }}  # 間違い
claude_code_oauth_token: ${{ secrets.CLAUDE_TOKEN }}        # 間違い
claude_code_oauth_token: ${{ secrets.OAUTH_TOKEN }}         # 間違い
```

**正しいSecret名:**
```yaml
claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}  # 正しい
```

### 確認方法

1. Secretsページで名前を確認
2. ワークフローファイルで参照名を確認
3. 完全に一致しているか確認（大文字・小文字を区別）

## エラー3: OAuth Tokenが期限切れ

### 症状

```
Error: Invalid or expired token
```

または:
```
401 Unauthorized
```

### 原因

OAuth Tokenの有効期限（1年間）が切れています。

### 解決策

#### ステップ1: 新しいOAuth Tokenを生成

```bash
npx claude setup-token
```

#### ステップ2: GitHubのSecretを更新

1. GitHubのSecretsページにアクセス
   ```
   https://github.com/your-username/your-repo/settings/secrets/actions
   ```

2. `CLAUDE_CODE_OAUTH_TOKEN` の **「Update」**をクリック

3. 新しいトークンを貼り付け

4. **「Update secret」**をクリック

#### ステップ3: 動作確認

Issueで `@claude` とメンションして、正常に動作するか確認します。

## エラー4: Permission denied

### 症状

```
Error: Permission denied to access repository
```

または:
```
403 Forbidden
```

### 原因

#### 原因1: Claude GitHub Appがインストールされていない

リポジトリにClaude GitHub Appがインストールされていません。

#### 原因2: リポジトリへのアクセス権限がない

Claude GitHub Appに、対象リポジトリへのアクセス権限が付与されていません。

### 解決策

#### 解決策1: Claude GitHub Appのインストール確認

```
https://github.com/settings/installations
```

- **Claude** が表示されているか確認
- 該当リポジトリにアクセス権限があるか確認

#### 解決策2: 権限の追加

1. **「Claude」**の**「Configure」**をクリック

2. **Repository access** を確認

3. 該当リポジトリを選択

4. **「Save」**をクリック

**設定例:**
```
Repository access:
● Only select repositories
  ☑ your-username/your-repo  ← チェックを入れる
```

## エラー5: ワークフローが実行されない

### 症状

Issueで `@claude` とメンションしても、何も起きません。

### 原因

#### 原因1: トリガー条件を満たしていない

コメントに `@claude` が含まれていない、または認識されていません。

#### 原因2: ワークフローファイルがGitHubにプッシュされていない

ローカルで `.github/workflows/claude.yml` を作成したが、GitHubにプッシュしていません。

#### 原因3: YAMLの文法エラー

ワークフローファイルに文法エラーがあり、パースに失敗しています。

### 解決策

#### 解決策1: トリガー条件の確認

**正しいメンション:**
```
@claude こんにちは
```

**認識されないメンション:**
```
claude こんにちは     ← @が付いていない
@ claude こんにちは   ← スペースが入っている
```

#### 解決策2: GitHubへのプッシュ確認

```bash
# ローカルの状態確認
git status

# まだコミットされていない場合
git add .github/workflows/claude.yml
git commit -m "feat: Add Claude Code Action workflow"
git push origin main
```

**GitHubでの確認:**
```
https://github.com/your-username/your-repo/blob/main/.github/workflows/claude.yml
```

ファイルが表示されればOKです。

#### 解決策3: YAMLの文法確認

**オンラインパーサーでチェック:**
```
https://yaml-online-parser.appspot.com/
```

1. ワークフローファイルの内容をコピー
2. 上記サイトに貼り付け
3. エラーがないか確認

**よくある文法エラー:**
```yaml
# インデントが間違っている
jobs:
claude-response:  # ← インデント不足
  runs-on: ubuntu-latest

# タブ文字を使っている（スペースを使うべき）
jobs:
→ claude-response:  # ← タブはNG

# コロンの後のスペースがない
name:Claude Code Action  # ← スペースがない
```

**正しい例:**
```yaml
jobs:
  claude-response:  # ← 正しいインデント（スペース2つ）
    runs-on: ubuntu-latest

name: Claude Code Action  # ← コロンの後にスペース
```

## エラー6: WSLでのパス認識問題

### 症状

WSL環境でOAuth Token生成時にエラーが発生します。

```
wsl: Failed to translate 'G:\マイドライブ...'
```

### 原因

WSLは日本語を含むWindowsパスを直接認識できません。

### 解決策

#### 方法1: PowerShellを使用（推奨）

WSLではなく、Windows PowerShellで実行します。

```powershell
# PowerShellで実行
npx claude setup-token
```

#### 方法2: WSLでパスを変換

```bash
# WSLでパスを変換
cd /mnt/g/マイドライブ/01_Obsidian/11_note/note_Obsidian

# トークン生成
npx claude setup-token
```

#### 方法3: WSL内でリポジトリをクローン

```bash
# WSLのホームディレクトリにクローン
cd ~
git clone https://github.com/your-username/your-repo.git
cd your-repo

# トークン生成
npx claude setup-token
```

## エラー7: `npm error 404 Not Found`

### 症状

OAuth Token生成時にエラーが発生します。

```bash
npm error 404 Not Found - GET https://registry.npmjs.org/@anthropic-ai%2fclaude-cli
npm error 404  '@anthropic-ai/claude-cli@*' is not in this registry.
```

### 原因

パッケージ名が間違っています。

### 解決策

**正しいコマンド:**
```bash
npx claude setup-token
```

**間違ったコマンド（使わない）:**
```bash
npx @anthropic-ai/claude-cli setup-token  # ❌
```

## エラー8: Claudeの応答が途中で止まる

### 症状

Claudeが作業を開始するが、途中で応答が止まります。

### 原因

#### 原因1: トークン制限

`max_tokens` の設定が小さすぎます。

#### 原因2: タイムアウト

処理時間が長すぎてタイムアウトしています。

### 解決策

#### 解決策1: `max_tokens` を増やす

ワークフローファイルで `max_tokens` を増やします。

```yaml
- name: Run Claude Code Action
  uses: anthropics/claude-code-action@v1
  with:
    claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
    github_token: ${{ secrets.GITHUB_TOKEN }}
    max_tokens: 16384  # デフォルト4096から増やす
```

#### 解決策2: タスクを分割

大きなタスクは小さく分割して依頼します。

**❌ 悪い例:**
```
@claude このプロジェクト全体をレビューして、
すべての問題を修正して、テストも追加して、
ドキュメントも更新してください。
```

**✅ 良い例:**
```
ステップ1:
@claude src/auth/ ディレクトリのコードをレビューしてください

ステップ2:（修正後）
@claude テストを追加してください

ステップ3:（テスト追加後）
@claude ドキュメントを更新してください
```

## 予防的なトラブルシューティング

### チェックリスト（セットアップ時）

セットアップ完了後、以下を確認してください。

#### GitHub App

- [ ] https://github.com/settings/installations でClaudeが表示される
- [ ] 該当リポジトリにアクセス権限がある

#### OAuth Token

- [ ] トークンが安全な場所に保存されている
- [ ] 有効期限を記録している（1年後）

#### GitHub Secrets

- [ ] `CLAUDE_CODE_OAUTH_TOKEN` が存在する
- [ ] 名前のスペルが正確

#### ワークフローファイル

- [ ] `.github/workflows/claude.yml` が存在する
- [ ] `actions/checkout@v4` ステップが含まれている
- [ ] YAMLの文法が正しい
- [ ] GitHubにプッシュされている

#### 動作確認

- [ ] Issueで `@claude` メンションが動作する
- [ ] PRで `@claude` メンションが動作する

### 定期的なメンテナンス

#### 月次

- [ ] GitHub Actionsのログを確認（エラーがないか）
- [ ] 不要なリポジトリへのアクセス権限を削除

#### 年次

- [ ] OAuth Tokenの有効期限を確認
- [ ] 必要に応じて新しいトークンを生成
- [ ] アクセス権限を見直し

## サポートとコミュニティ

### 公式リソース

**公式ドキュメント:**
- https://docs.anthropic.com/claude/docs/claude-code-action

**GitHub リポジトリ:**
- https://github.com/anthropics/claude-code-action

### コミュニティ

**質問・相談:**
- GitHub Discussions（公式リポジトリ）
- Stack Overflow（`claude-code` タグ）

### バグ報告

公式リポジトリでIssueを作成します。

**報告時に含めるべき情報:**
- エラーメッセージ
- GitHub Actionsのログ（機密情報を除く）
- ワークフローファイルの内容
- 再現手順

## まとめ

### よくあるエラートップ3

| エラー | 原因 | 解決策 |
|--------|------|--------|
| **fatal: not a git repository** | `actions/checkout@v4` 不足 | ワークフローに追加 |
| **CLAUDE_CODE_OAUTH_TOKEN not found** | Secret未設定 | GitHub Secretsに追加 |
| **Permission denied** | Claude App未インストール | インストールと権限付与 |

### トラブルシューティングの流れ

```
1. エラーメッセージを確認
    ↓
2. GitHub Actionsのログを詳細に確認
    ↓
3. この章の該当エラーを参照
    ↓
4. 解決策を実施
    ↓
5. 動作確認
```

### 成功の秘訣

1. **丁寧なセットアップ**: 各ステップを確実に実行
2. **チェックリスト活用**: 見落としを防ぐ
3. **ログの確認**: エラーの早期発見
4. **定期的なメンテナンス**: 問題の予防

### 第9章の完了

これで第9章「GitHub Actions連携」が完了しました。Claude Code Actionを活用することで、GitHub上での開発効率が大幅に向上します。

**活用のポイント:**
- Issueでの質問応答
- PRでの自動レビュー
- コード実装支援
- ドキュメント生成

チーム開発でぜひ活用してください！
