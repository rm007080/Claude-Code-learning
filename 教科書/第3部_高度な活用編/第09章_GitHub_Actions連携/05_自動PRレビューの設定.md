# 自動PRレビューの設定

## はじめに

この章では、Pull Requestで `@claude` とメンションするだけで、自動的にコードレビューが実行される仕組みを学びます。チーム開発で非常に役立つ機能です。

## 自動PRレビューとは

### 概要

**自動PRレビュー**は、Pull Requestのコメントで `@claude` とメンションすると、Claude AIが自動的にコードをレビューしてくれる機能です。

**実現できること:**
- ✅ コード品質のチェック
- ✅ セキュリティの脆弱性検出
- ✅ ベストプラクティスの提案
- ✅ テストカバレッジの確認
- ✅ パフォーマンスの問題指摘

## 動作確認

### ステップ1: Issueでのテスト

まず、Issueで動作を確認します。

**手順:**

1. **Issueの作成**
   ```
   https://github.com/your-username/your-repo/issues/new
   ```

2. **内容の入力**
   ```
   Title: Test Claude Code Action
   Comment: Hello!
   ```

3. **Issueを作成**
   「Submit new issue」をクリック

4. **Claudeを呼び出す**
   Issueのコメント欄に以下を入力:
   ```
   @claude こんにちは！あなたは誰ですか？
   ```

5. **結果を確認**
   数秒〜数十秒後、**github-actions bot** が自動でコメント

**期待される応答例:**
```
✓ Claude finished @your-username's task

こんにちは！私はClaudeです。Anthropic社によって開発されたAIアシスタントで、
GitHub上でコードレビューや実装のサポートを行うことができます。

Claude Code Actionを通じて、以下のようなお手伝いができます：
• コードの質問への回答
• コードレビューとフィードバック
• コードの変更や実装
• プルリクエストの作成
```

### ステップ2: Pull Requestでの動作確認

次に、実際のPRでレビュー機能を確認します。

**手順:**

1. **新しいブランチを作成**
   ```bash
   git checkout -b feature/test-pr
   ```

2. **簡単な変更を加える**
   ```bash
   # 例: README.mdに行を追加
   echo "## Test" >> README.md
   git add README.md
   git commit -m "test: Add test section to README"
   git push origin feature/test-pr
   ```

3. **Pull Requestを作成**
   ```
   https://github.com/your-username/your-repo/compare
   ```

4. **PRの説明を記入**
   ```
   Title: Test Claude Code Action on PR
   Description:
   Claude Code Actionのテストです。
   @claude でレビューをお願いできるか確認します。
   ```

5. **PRを作成**
   「Create pull request」をクリック

6. **Claudeにレビューを依頼**
   PRのコメント欄に以下を入力:
   ```
   @claude この変更をレビューしてください
   ```

7. **結果を確認**
   Claudeが自動的にレビューコメントを追加

## 実践的な活用方法

### 基本的なレビュー依頼

```
@claude この変更をレビューしてください
```

Claude の応答例:
```
変更内容を確認しました。

【変更サマリー】
- README.mdに新しいセクションを追加

【レビュー結果】
✅ 良い点:
- 明確なコミットメッセージ
- シンプルな変更

💡 提案:
- セクションの内容をもう少し具体的に記述すると良いでしょう

【総合評価】
承認（Approve）可能です。
```

### 具体的な観点を指定したレビュー

```
@claude この変更をレビューしてください。特に以下に注意してください：
- セキュリティの脆弱性
- パフォーマンスへの影響
- テストカバレッジ
```

### コードの一部のみレビュー

```
@claude この関数のロジックをレビューしてください

\`\`\`typescript
function calculateTotal(items: Item[]): number {
  return items.reduce((sum, item) => sum + item.price, 0);
}
\`\`\`
```

### 質問形式でのレビュー

```
@claude このエラーハンドリングは適切でしょうか？
より良い方法があれば教えてください。
```

## チーム開発での活用

### レビュープロセスへの組み込み

#### フロー例

```
1. 開発者がPRを作成
    ↓
2. @claude でレビューを依頼
    ↓
3. Claudeが自動レビュー
    ↓
4. 指摘事項を修正
    ↓
5. 人間のレビュアーが最終確認
    ↓
6. Merge
```

#### メリット

- ✅ 基本的な問題を早期発見
- ✅ 人間のレビュアーの負担軽減
- ✅ 一貫したレビュー基準
- ✅ 24時間365日対応

### PRテンプレートの作成

`.github/pull_request_template.md` を作成し、Claudeへの依頼を含めます。

```markdown
## 変更内容

<!-- 変更内容を記述 -->

## チェックリスト

- [ ] テストを追加・更新した
- [ ] ドキュメントを更新した
- [ ] Lintエラーがない

## Claudeによるレビュー

@claude この変更をレビューしてください。特に以下に注意してください：
- セキュリティの脆弱性
- コード品質
- テストカバレッジ
```

### レビューガイドラインの設定

`CLAUDE.md` ファイルでレビュー基準を定義します。

```markdown
# Claude Code レビューガイドライン

## レビュー観点

### 必須チェック項目

1. **セキュリティ**
   - SQLインジェクション対策
   - XSS対策
   - 認証・認可の適切な実装

2. **コード品質**
   - 型安全性
   - エラーハンドリング
   - 命名規則

3. **テスト**
   - 単体テストの存在
   - カバレッジ70%以上
   - エッジケースのテスト

## レビューフォーマット

以下の形式で報告してください：

### 変更サマリー
- 変更の概要

### 重要度別の指摘
- 🔴 Critical（致命的）
- 🟠 High（重要）
- 🟡 Medium（中程度）
- 🟢 Low（軽微）

### 推奨事項
- 具体的な改善提案
```

## 高度な活用例

### 段階的なレビュー

```
ステップ1: 全体構造のレビュー
@claude この変更の全体構造をレビューしてください

ステップ2: 詳細レビュー
@claude 指摘された問題を修正しました。再度レビューをお願いします

ステップ3: 最終確認
@claude この変更は本番環境にデプロイできる状態ですか？
```

### 複数の観点からのレビュー

```
セキュリティ観点:
@claude セキュリティの観点からレビューしてください。
OWASP Top 10に基づいて評価してください。

パフォーマンス観点:
@claude パフォーマンスの観点からレビューしてください。
ボトルネックや最適化の余地を指摘してください。

テスト観点:
@claude テストの観点からレビューしてください。
不足しているテストケースを提案してください。
```

### 実装支援

```
@claude この機能を実装してください

要件:
- ユーザー認証機能
- JWT トークンを使用
- リフレッシュトークンの実装
- TypeScript + Express

実装後、自動でテストも作成してください。
```

## GitHub Actionsのログ確認

### ログへのアクセス

```
https://github.com/your-username/your-repo/actions
```

**確認内容:**
- 実行時間
- 成功/失敗
- エラーメッセージ
- Claudeの応答内容

### ログの読み方

```
Run Claude Code Action
  ✓ Checkout repository
  ✓ Run Claude Code Action
    ├─ Parsing comment
    ├─ Fetching repository context
    ├─ Analyzing code changes
    ├─ Generating review
    └─ Posting comment
  ✓ Complete
```

## トラブルシューティング

### 問題: Claudeが応答しない

**確認項目:**
1. GitHub Actionsが実行されているか
   ```
   https://github.com/your-username/your-repo/actions
   ```

2. ワークフローのログを確認
   - エラーメッセージを読む

3. トリガー条件
   - コメントに `@claude` が含まれているか
   - IssueまたはPRのコメントか（通常のコメント欄では動作しない）

### 問題: レビューが途中で止まる

**原因:** トークン制限、または処理時間の超過

**解決策:**
1. より具体的な指示を出す
2. レビュー範囲を分割する
3. `max_tokens` を増やす（ワークフローファイル）

### 問題: レビューの質が低い

**原因:** コンテキスト情報の不足

**解決策:**
1. `CLAUDE.md` でレビュー基準を明確に定義
2. より具体的な質問をする
3. プロジェクトのドキュメントを充実させる

## ベストプラクティス

### レビュー依頼の書き方

**❌ 悪い例:**
```
@claude レビューして
```

**✅ 良い例:**
```
@claude この変更をレビューしてください。

【背景】
認証機能のリファクタリングです。

【確認してほしいこと】
- セキュリティの脆弱性
- JWT トークンの適切な管理
- エラーハンドリング

【特に注意すべき箇所】
src/auth/jwt.ts の署名検証ロジック
```

### レビュー結果への対応

```
1. Claudeのレビューを確認
    ↓
2. 指摘事項を分類
   - 即座に修正すべきもの
   - 検討が必要なもの
   - 将来の課題とするもの
    ↓
3. 修正を実施
    ↓
4. 再度Claudeにレビューを依頼
    @claude 指摘事項を修正しました。再レビューをお願いします
    ↓
5. 人間のレビュアーに依頼
```

## まとめ

### 自動PRレビューの効果

| 効果 | 説明 |
|------|------|
| **早期発見** | 基本的な問題を即座に検出 |
| **一貫性** | 常に同じ基準でレビュー |
| **効率化** | 人間のレビュアーの負担軽減 |
| **学習** | レビューコメントから学べる |

### 活用のコツ

1. **明確な指示**: 何を確認してほしいか明確に
2. **段階的**: 全体→詳細の順でレビュー
3. **ガイドライン**: `CLAUDE.md` で基準を定義
4. **補完的**: 人間のレビューと組み合わせる

### 次章の内容

次の章では、よくあるエラーと解決方法を詳しく解説します。実際の設定記録から得られたトラブルシューティングのノウハウを学びます。
