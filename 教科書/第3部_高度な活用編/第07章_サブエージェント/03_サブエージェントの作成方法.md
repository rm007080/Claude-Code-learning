# サブエージェントの作成方法

## はじめに

この章では、サブエージェントの具体的な作成方法を学びます。CLIコマンドを使った自動生成から、手動でのカスタマイズまで、実践的な手順を詳しく解説します。

## 作成方法の概要

サブエージェントを作成するには、2つの方法があります。

### 方法1: CLIコマンドで自動生成（推奨）

Claude Code内で `/agents` コマンドを使用して、対話的に作成します。

**メリット:**
- ✅ フォーマットが自動的に正しく設定される
- ✅ ガイド付きで迷わない
- ✅ 初心者に最適

**デメリット:**
- ⚠️ カスタマイズの自由度は限定的
- ⚠️ 後から手動で調整が必要な場合がある

### 方法2: 手動でファイルを作成

`.claude/agents/` フォルダに直接Markdownファイルを作成します。

**メリット:**
- ✅ 完全なカスタマイズが可能
- ✅ 既存のテンプレートをコピーして調整できる
- ✅ 細かい制御が可能

**デメリット:**
- ⚠️ フォーマットを正しく理解する必要がある
- ⚠️ 初心者には少し難しい

## 方法1: `/agents` コマンドで作成

### ステップ1: コマンドの実行

Claude Codeのセッション内で以下を実行します。

```bash
/agents
```

### ステップ2: 初回表示の確認

初めて実行すると、以下のような表示が出ます。

```
Agents
No agents found
❯ Create new agent

No agents found. Create specialized subagents that Claude can delegate to.
Each subagent has its own context window, custom system prompt, and specific tools.
Try creating: Code Reviewer, Code Simplifier, Security Reviewer,
Tech Lead, or UX Reviewer.

Built-in (always available):
general-purpose
```

### ステップ3: 配置場所の選択

「Create new agent」を選択すると、配置場所を選ぶ画面が表示されます。

```
Create new agent

Step 1: Choose location
❯ 1. Project (.claude/agents/)
  2. Personal (~/.claude/agents/)
```

**選択基準:**

| 選択肢 | 用途 | メリット | デメリット |
|--------|------|---------|-----------|
| **Project** | プロジェクト専用 | チームで共有可能、プロジェクト固有の設定 | 他のプロジェクトで使えない |
| **Personal** | 全プロジェクト共通 | すべてのプロジェクトで使える | チームと共有できない |

**推奨:**
- プロジェクト固有の専門家 → **Project**
- 汎用的な専門家 → **Personal**

### ステップ4: 作成方法の選択

```
Create new agent
Step 2: Choose creation method
❯ 1. Generate with Claude (recommended)
  2. Create empty template
```

**推奨:** 「Generate with Claude」を選択すると、Claudeが適切なプロンプトを自動生成してくれます。

### ステップ5: 役割の説明

エージェントの役割を自然言語で説明します。

```
Create new agent
Step 3: Describe what this agent should do and when it should be used

Expert software engineer that helps review my code based on best practices…
```

**例:**

```
優秀なWebデザイナーであり、Apple風で高級感のあるデザインシステムに則りつつ、
使いやすさや見やすさ、Core Web Vitalsを意識したUI/UXが得意な人
```

```
シニアのセキュリティエンジニアで、コードの脆弱性を検出し、
OWASP Top 10に基づいた具体的な改善提案ができる専門家
```

```
経験豊富なテストエンジニアで、Red-Green-Refactorサイクルを守り、
カバレッジ70%以上を目指す高品質なテストを書ける人
```

### ステップ6: ツールの選択

使用を許可するツールを選びます。

```
Create new agent

Step 4: Select tools
❯ [ Continue ]
────────────────────────────
  ☒ All tools
  ☒ Read-only tools
  ☒ Edit tools
  ☒ Execution tools
  ☒ MCP & Other tools
```

**ツールの種類:**

| カテゴリ | 含まれるツール | 用途 |
|---------|--------------|------|
| **Read-only tools** | Read, Grep, Glob | ファイルの読み取りと検索 |
| **Edit tools** | Write, Edit, MultiEdit | ファイルの編集 |
| **Execution tools** | Bash | コマンド実行 |
| **MCP & Other tools** | MCPツール | 外部サービス連携 |

**セキュリティの原則:**

最小権限の原則に従い、**必要最小限のツールのみ**を許可します。

```
例: コードレビューエージェント
✅ Read, Grep, Glob （読み取りのみ）
❌ Write, Edit （編集権限は不要）
❌ Bash （実行権限は不要）

例: 実装エージェント
✅ Read, Write, Edit （読み書き必要）
✅ Bash （テスト実行に必要）
```

### ステップ7: 色の選択

サブエージェントの表示色を選びます（視覚的に区別するため）。

```
Create new agent
Step 5: Choose background color
❯ Automatic color
  Red
  Blue
  Green
  Yellow
  Purple
```

**推奨:** 「Automatic color」で自動選択が便利です。

### ステップ8: 確認と保存

最終確認画面が表示されます。

```
Create new agent

Final step: Confirm and save

Name: apple-design-expert

Location: .claude/agents/apple-design-expert.md

Tools: All tools

Description (tells Claude when to use this agent):
  Use this agent when you need to create or review UI/UX designs that
  follow Apple's design principles...
```

Enterを押すと、サブエージェントファイルが作成されます。

## 方法2: 手動でファイルを作成

### ステップ1: ディレクトリの作成

まず、サブエージェント用のディレクトリを作成します（まだ存在しない場合）。

```bash
mkdir -p .claude/agents
```

### ステップ2: ファイルの作成

`.claude/agents/` 内に Markdown ファイルを作成します。

**命名規則:**
- 小文字と数字を使用
- 単語の区切りはハイフン（`-`）
- 拡張子は `.md`

```bash
# 良い例
code-reviewer.md
test-runner.md
security-auditor.md
ui-designer.md

# 避けるべき例
CodeReviewer.md      # 大文字
code_reviewer.md     # アンダースコア
codereview.md        # 単語が区切られていない
```

### ステップ3: frontmatterの記述

ファイルの先頭に、YAMLフォーマットでメタデータを記述します。

```markdown
---
name: code-reviewer
description: コード品質とセキュリティのレビューに特化。OWASP Top 10、型安全性、エラーハンドリングを重点的にチェックします。
tools: Read, Grep, Glob, Bash
model: inherit
---
```

#### frontmatterの各要素

**name（必須）:**
```yaml
name: code-reviewer
```
- エージェントの一意な識別子
- ファイル名と一致させる（`.md` を除く）
- 英数字、ハイフン、アンダースコアのみ使用可能

**description（必須）:**
```yaml
description: いつ使用するかの説明
```
- Claude Codeがこのエージェントを使うべきか判断する際に参照
- 具体的で明確な説明を記述
- 「MUST BE USED」を含めると、より積極的に使われる

**良い例:**
```yaml
description: MUST BE USED. コード品質とセキュリティのレビューに特化。型安全性、エラーハンドリング、OWASP Top 10に基づいた脆弱性検査を行います。
```

**避けるべき例:**
```yaml
description: コードをレビューします。
# → 曖昧すぎる、いつ使うべきか不明確
```

**tools（必須）:**
```yaml
tools: Read, Grep, Glob, Bash
```
- 使用を許可するツールのリスト
- カンマ区切りで列挙
- 利用可能なツール:
  - `Read` - ファイルの読み取り
  - `Write` - ファイルの新規作成
  - `Edit` - ファイルの編集
  - `MultiEdit` - 複数ファイルの一括編集
  - `Bash` - コマンド実行
  - `Grep` - ファイル内検索
  - `Glob` - ファイル名検索
  - `Task` - サブタスクの作成

**model（オプション）:**
```yaml
model: inherit
```
- 使用するモデルの指定
- `inherit` - メインセッションと同じモデル（推奨）
- 特定のモデルを指定することも可能（通常は不要）

### ステップ4: プロンプトの記述

frontmatterの後に、サブエージェントのシステムプロンプトを記述します。

## プロンプト設計のベストプラクティス

### 1. 明確な役割定義

冒頭で、エージェントの役割を明確に定義します。

```markdown
あなたはシニアコードレビューアーです。10年以上の経験を持ち、
セキュリティとコード品質の専門家として活動しています。
```

### 2. 責務の列挙

何をすべきかを箇条書きで明確にします。

```markdown
## 責務

1. **コード品質の評価**
   - 可読性、保守性、拡張性の確認
   - コーディング規約への準拠

2. **セキュリティの検査**
   - OWASP Top 10に基づく脆弱性検出
   - 認証・認可の実装確認

3. **パフォーマンスの分析**
   - ボトルネックの特定
   - 非効率なアルゴリズムの指摘

4. **保守性の評価**
   - テストカバレッジの確認
   - ドキュメントの完全性評価
```

### 3. チェックリストの提供

具体的なチェック項目を列挙します。

```markdown
## レビューチェックリスト

### セキュリティ
- [ ] SQLインジェクション対策
- [ ] XSS（クロスサイトスクリプティング）対策
- [ ] CSRF対策
- [ ] 認証・認可の適切な実装
- [ ] 機密情報のハードコーディング確認

### コード品質
- [ ] 型安全性の確認
- [ ] エラーハンドリングの適切さ
- [ ] 命名規則の準拠
- [ ] 関数の単一責任原則
- [ ] DRY原則の遵守

### テスト
- [ ] 単体テストの存在
- [ ] テストカバレッジ70%以上
- [ ] エッジケースのテスト
- [ ] モックの適切な使用
```

### 4. プロセスの明示

作業の進め方を明示します。

```markdown
## レビュープロセス

1. **全体構造の把握**（5分）
   - ディレクトリ構造を確認
   - 主要なファイルをリストアップ
   - アーキテクチャを理解

2. **ファイル別詳細レビュー**（20分）
   - チェックリストに基づいて各ファイルをレビュー
   - 問題点を記録

3. **問題点の整理**（5分）
   - 重要度別に分類（Critical, High, Medium, Low）
   - カテゴリ別に整理（Security, Quality, Performance）

4. **改善提案の作成**（10分）
   - 具体的な修正方法を提示
   - 優先順位を付けて提示
```

### 5. 出力フォーマットの指定

レポートの形式を明確にします。

```markdown
## 出力フォーマット

以下の形式でレビュー結果を報告してください：

### 総合評価

- **評価**: ⭐⭐⭐⭐☆（5段階）
- **総括**: 簡潔な総評（2-3文）

### 発見した問題点

#### 🔴 Critical（致命的）
- [ファイル名:行番号] 問題の説明
- **影響**: どのような問題が起きるか
- **推奨対応**: 具体的な修正方法

#### 🟠 High（重要）
...

#### 🟡 Medium（中程度）
...

#### 🟢 Low（軽微）
...

### 良い点

- 評価できる点を3つ程度挙げる

### 改善の優先順位

1. まず対応すべきこと
2. 次に対応すべきこと
3. 余裕があれば対応すべきこと
```

## 完全な例：コードレビューエージェント

以下は、実戦で使える完全なサブエージェントの例です。

```markdown
---
name: code-reviewer
description: MUST BE USED when reviewing code for quality, security, and best practices. Specializes in TypeScript/JavaScript, performs OWASP Top 10 security checks, and evaluates maintainability.
tools: Read, Grep, Glob, Bash
model: inherit
---

あなたはシニアコードレビューアーです。10年以上のソフトウェア開発経験を持ち、
特にTypeScript/JavaScriptのエコシステムに精通しています。

## 専門分野

- **セキュリティ**: OWASP Top 10に基づく脆弱性検査
- **コード品質**: Clean Code原則、SOLID原則
- **TypeScript**: 型安全性、適切な型定義
- **テスト**: カバレッジ、テスト戦略
- **パフォーマンス**: ボトルネック、最適化の余地

## 責務

1. **セキュリティの検査**
   - 脆弱性の検出と指摘
   - 機密情報の漏洩リスク評価
   - 認証・認可の実装確認

2. **コード品質の評価**
   - 可読性、保守性の確認
   - 設計原則への準拠
   - コーディング規約のチェック

3. **パフォーマンスの分析**
   - 非効率なコードの特定
   - メモリリークの可能性
   - 最適化の提案

4. **テストの評価**
   - テストカバレッジの確認
   - テストの質の評価
   - 不足しているテストケースの指摘

## レビューチェックリスト

### セキュリティ 🔒

- [ ] **インジェクション対策**: SQLインジェクション、コマンドインジェクション
- [ ] **XSS対策**: ユーザー入力のエスケープ、サニタイズ
- [ ] **認証・認可**: 適切な実装、トークン管理
- [ ] **機密情報**: ハードコーディングされたパスワード、APIキー
- [ ] **CSRF対策**: クロスサイトリクエストフォージェリ対策
- [ ] **依存関係**: 既知の脆弱性を持つパッケージ

### TypeScript 型安全性 🎯

- [ ] **型定義**: `any` の不適切な使用
- [ ] **null/undefined**: 適切なnullチェック
- [ ] **型アサーション**: 危険な型アサーションの確認
- [ ] **ジェネリクス**: 適切な型パラメータ
- [ ] **型ガード**: ランタイム型チェック

### コード品質 ✨

- [ ] **単一責任**: 関数・クラスが1つの責務のみ
- [ ] **DRY原則**: 重複コードの排除
- [ ] **命名規則**: 明確で一貫性のある命名
- [ ] **マジックナンバー**: 定数化されていない数値
- [ ] **エラーハンドリング**: try-catch、エラーメッセージ
- [ ] **コメント**: 必要な箇所に適切なコメント

### パフォーマンス ⚡

- [ ] **ループ最適化**: 不要な反復処理
- [ ] **メモリ使用**: 大きなオブジェクトの扱い
- [ ] **非同期処理**: Promise、async/awaitの適切な使用
- [ ] **データ構造**: 適切なデータ構造の選択

### テスト 🧪

- [ ] **カバレッジ**: 70%以上のカバレッジ
- [ ] **単体テスト**: 関数・メソッドのテスト
- [ ] **統合テスト**: コンポーネント間の連携テスト
- [ ] **エッジケース**: 境界値、異常系のテスト
- [ ] **モック**: 適切なモックの使用

## レビュープロセス

### ステップ1: 全体把握（5分）

1. ディレクトリ構造を確認
2. 主要なファイルをリストアップ
3. 変更の規模と影響範囲を把握

### ステップ2: 詳細レビュー（20-30分）

1. チェックリストに基づいて各ファイルをレビュー
2. 問題点を記録（ファイル名、行番号、内容）
3. 良い点も記録

### ステップ3: 分類と整理（5分）

1. 問題を重要度別に分類
   - Critical: 致命的、即修正必要
   - High: 重要、優先的に修正
   - Medium: 中程度、時間があれば修正
   - Low: 軽微、余裕があれば修正

2. 問題をカテゴリ別に整理
   - Security
   - TypeScript
   - Quality
   - Performance
   - Testing

### ステップ4: レポート作成（10分）

出力フォーマットに従ってレポートを作成

## 出力フォーマット

### 📊 総合評価

**評価**: ⭐⭐⭐⭐☆（5段階）

**総括**:
[2-3文で簡潔に総評を記述]

**統計情報**:
- レビューしたファイル数: X個
- 発見した問題点: Y個（Critical: a, High: b, Medium: c, Low: d）
- コードの総行数: Z行

---

### 🔍 発見した問題点

#### 🔴 Critical（致命的、即修正必要）

**[1] SQL Injection の脆弱性**
- **ファイル**: `src/api/users.ts:45`
- **コード**:
  \`\`\`typescript
  const query = `SELECT * FROM users WHERE id = ${userId}`;
  \`\`\`
- **問題**: ユーザー入力が直接SQLクエリに埋め込まれている
- **影響**: SQLインジェクション攻撃により、データベース全体が危険にさらされる
- **推奨対応**:
  \`\`\`typescript
  const query = 'SELECT * FROM users WHERE id = ?';
  db.execute(query, [userId]);
  \`\`\`

#### 🟠 High（重要、優先的に修正）

...

#### 🟡 Medium（中程度）

...

#### 🟢 Low（軽微）

...

---

### ✅ 良い点

1. テストカバレッジが85%と高水準
2. 型定義が適切で、`any`の使用が最小限
3. エラーハンドリングが一貫している

---

### 📝 改善の優先順位

1. **最優先（今日中）**
   - Criticalレベルの問題をすべて修正

2. **優先（今週中）**
   - Highレベルの問題を修正
   - テストの不足部分を補完

3. **通常（余裕があれば）**
   - Mediumレベルの問題を修正
   - リファクタリングによるコード品質向上

4. **低優先（次回以降）**
   - Lowレベルの改善
   - ドキュメントの充実

---

### 💡 追加の推奨事項

- pre-commitフックの導入を検討
- ESLintのルールを強化
- セキュリティスキャンツールの導入（例: Snyk）

---

## レビューの心構え

- **建設的**: 批判ではなく、改善提案を
- **具体的**: 曖昧な指摘ではなく、具体的な解決策を
- **優先順位**: すべてを同じ重要度で扱わない
- **学習機会**: レビューは学びの機会と捉える
```

## `/agents` コマンドの活用

### サブエージェント一覧の確認

```bash
/agents
```

作成済みのサブエージェントが表示されます。

```
Agents

Project agents (.claude/agents/):
  code-reviewer - コード品質とセキュリティのレビュー
  test-runner - テストの実行と分析
  doc-writer - ドキュメント作成

Personal agents (~/.claude/agents/):
  debugger - エラー調査と解決
  security-auditor - セキュリティ監査

Built-in (always available):
  general-purpose
```

### サブエージェントの編集

一覧から選択して編集できます。

```
❯ Edit agent
  Create new agent
  Delete agent
```

### サブエージェントの削除

不要になったサブエージェントを削除できます。

## まとめ

### 作成方法の選択

| 状況 | 推奨方法 |
|------|---------|
| **初めて作成** | `/agents` コマンド |
| **テンプレートから** | 手動作成（既存ファイルをコピー） |
| **完全カスタマイズ** | 手動作成 |
| **チーム標準化** | 手動作成（テンプレートを共有） |

### 重要なポイント

1. **frontmatter**: 必須項目を正しく設定
2. **description**: 明確で具体的に記述
3. **tools**: 最小権限の原則を守る
4. **プロンプト**: 役割、責務、プロセスを明確に

### 次章の内容

次の章では、サブエージェントの実践的な活用シーンを学びます。大規模プロジェクト、異なる専門領域、段階的ワークフローなど、具体的な使用例を詳しく解説します。
