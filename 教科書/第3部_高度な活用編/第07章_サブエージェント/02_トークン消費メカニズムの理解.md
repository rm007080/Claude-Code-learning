# トークン消費メカニズムの理解

## はじめに

サブエージェントのトークン消費メカニズムは、多くの人が誤解しやすいポイントです。この章では、正しい理解を得るために、よくある誤解と正しい仕組みを詳しく解説します。

## よくある誤解

### ❌ 誤解1: 「サブエージェントは独立したトークン予算を持つ」

**これは間違いです。**

多くの人が、サブエージェントには「別枠のトークン予算」があると誤解しています。しかし、実際にはそうではありません。

### ❌ 誤解2: 「サブエージェントのトークン消費はメインセッションに影響しない」

**これも間違いです。**

サブエージェントがトークンを消費すると、それはあなたのアカウント全体のトークン予算から差し引かれます。

### ❌ 誤解3: 「サブエージェントを使えばトークンを節約できる」

**短期的には間違いです。**

サブエージェントは即座にトークンを節約する魔法のツールではありません。むしろ、並列実行では消費速度が上がります。

## 正しい理解

### ✅ 正しい理解1: トークン予算は共有

サブエージェントはメインセッション**と同じトークンプール**から消費します。

```
ユーザーの総トークン予算（例：Pro planの場合）
└── 5時間ローリング制限
    ├── メインセッション
    ├── サブエージェント1
    ├── サブエージェント2
    └── サブエージェント3

すべてが同じプールから消費される
```

### ✅ 正しい理解2: コンテキストウィンドウのみ分離

サブエージェントが持つ「独立性」とは、**トークン予算**ではなく、**コンテキストウィンドウ（過去の作業履歴）**の分離を意味します。

```
各サブエージェント = 200,000トークンの独立したコンテキスト窓

これは「トークン予算を持つ」という意味ではなく、
「過去の作業履歴が混ざらない」という意味
```

### ✅ 正しい理解3: 長期的な効率化

サブエージェントは、**長期的には**トークンを節約できます。同じ指示を毎回与える必要がなくなるためです。

## トークン予算構造の詳細

### Proプランの例

```
Proプラン
├── 5時間ローリング制限: 例えば50万トークン
│   ├── メインセッション: 20万トークン消費
│   ├── サブエージェント1（レビュー）: 10万トークン消費
│   ├── サブエージェント2（テスト）: 8万トークン消費
│   └── サブエージェント3（ドキュメント）: 7万トークン消費
│
└── 残り5万トークン

※ 全てのセッションが同じプールから消費
```

### 重要な数字

| プラン | 5時間制限の目安 | トークン単価 |
|--------|----------------|-------------|
| **Pro** | 比較的制限あり | 含まれる |
| **Max** | 大幅に緩和 | 含まれる |

※ 正確な制限値はAnthropic社により非公開

## 並列実行とトークン消費速度

### 実例：300ファイル以上の更新タスク

実際のプロジェクトで検証された数値です。

| 実行方法 | 処理時間 | トークン消費速度 | 合計トークン消費 |
|---------|---------|-----------------|----------------|
| **順序実行**（単一エージェント） | 約30分 | 標準速度 | 例：30万トークン |
| **並列実行**（3つのサブエージェント） | 約15分 | **2-3倍の速度** | 例：30万トークン |

### 重要な洞察

**並列実行で「速度が2倍」になるということは、「トークン消費も2倍の速度」という意味です。**

- ✅ **作業は速く終わる**（時間短縮）
- ⚠️ **トークン予算は速く消費される**（5時間制限への到達が早い）
- ✅ **総トークン消費量は変わらない**（同じ作業なら同じ量）

### 視覚的な説明

```
【順序実行】
時刻 0分 ──── 15分 ──── 30分
      │                    │
      タスク開始           タスク完了
      │
      トークン消費: ゆっくり30万トークン

【並列実行（3エージェント）】
時刻 0分 ──── 15分
      │           │
      タスク開始  タスク完了
      │
      トークン消費: 急速に30万トークン
                   （3エージェント同時）
```

## トークン消費の具体例

### 例1: 単一タスクの比較

**タスク**: 100ファイルのコードレビュー

**メインセッションのみ:**
```
時間: 20分
トークン消費: 15万トークン
消費速度: 7,500トークン/分
```

**サブエージェント使用:**
```
時間: 20分
トークン消費: 15万トークン + α
消費速度: 約8,000トークン/分

α = サブエージェント起動コスト（プロンプト読み込み等）
   約2,000-5,000トークン
```

### 例2: 並列タスクの比較

**タスク**: 3つの独立したレビュー作業

**順序実行（メインセッションのみ）:**
```
タスク1: 10分 → 5万トークン
タスク2: 10分 → 5万トークン
タスク3: 10分 → 5万トークン
─────────────────────────
合計:   30分 → 15万トークン
消費速度: 5,000トークン/分
```

**並列実行（3つのサブエージェント）:**
```
タスク1（並列）: 10分 → 5万トークン
タスク2（並列）: 10分 → 5万トークン
タスク3（並列）: 10分 → 5万トークン
─────────────────────────────────
合計:          10分 → 15万トークン
消費速度: 15,000トークン/分（3倍）
```

## 5時間ローリング制限の仕組み

### ローリングウィンドウとは

「5時間ローリング制限」とは、過去5時間分のトークン消費の合計が制限値を超えないようにする仕組みです。

```
時刻: 10:00  11:00  12:00  13:00  14:00  15:00  16:00
      │      │      │      │      │      │      │
消費: 10万   8万    12万   15万   9万    7万    ?

15:00時点での過去5時間（10:00-15:00）:
10万 + 8万 + 12万 + 15万 + 9万 = 54万トークン

制限値が50万の場合 → 制限超過、15:00は使用不可

16:00時点での過去5時間（11:00-16:00）:
8万 + 12万 + 15万 + 9万 + 7万 = 51万トークン
（10:00の10万が範囲外になる）
```

### 並列実行の影響

並列実行で急速にトークンを消費すると、5時間制限に早く到達します。

```
【通常使用】
0時間目: 10万トークン消費
1時間目: 8万トークン消費
2時間目: 9万トークン消費
3時間目: 10万トークン消費
4時間目: 8万トークン消費
─────────────────────────
5時間で: 45万トークン（制限内）

【並列実行多用】
0時間目: 20万トークン消費（3エージェント並列）
1時間目: 18万トークン消費（3エージェント並列）
2時間目: 15万トークン消費（2エージェント並列）
─────────────────────────────────────
3時間で: 53万トークン（制限超過の可能性）
```

## サブエージェント起動のコスト

サブエージェントを起動するたびに、以下のコストがかかります。

### 起動時のトークン消費

```
サブエージェント起動コスト
├── システムプロンプト読み込み: 2,000-5,000トークン
├── スキル/ルール読み込み: 1,000-3,000トークン
├── タスク説明: 500-2,000トークン
└── コンテキスト設定: 500-1,000トークン

合計: 約4,000-11,000トークン/起動
```

### 頻繁な起動は非効率

```
❌ 悪い例: 小さなタスクごとにサブエージェントを起動
タスク1: レビュー起動コスト 5,000トークン + 作業 3,000トークン
タスク2: レビュー起動コスト 5,000トークン + 作業 3,000トークン
タスク3: レビュー起動コスト 5,000トークン + 作業 3,000トークン
─────────────────────────────────────────────────
合計: 24,000トークン

✅ 良い例: まとめて1回のサブエージェント起動
タスク1-3まとめて: 起動コスト 5,000トークン + 作業 9,000トークン
─────────────────────────────────────────────────
合計: 14,000トークン（10,000トークンの節約）
```

## 長期的なトークン効率

### 短期 vs 長期の比較

**短期的（1-2回の使用）:**
```
手動指示:
├── 指示を毎回入力: 500トークン × 2回 = 1,000トークン
└── 作業実行: 10,000トークン × 2回 = 20,000トークン
合計: 21,000トークン

サブエージェント:
├── 初回定義: 3,000トークン（1回のみ）
├── 起動コスト: 5,000トークン × 2回 = 10,000トークン
└── 作業実行: 10,000トークン × 2回 = 20,000トークン
合計: 33,000トークン

→ 短期的には手動指示の方が効率的
```

**長期的（10回以上の使用）:**
```
手動指示:
├── 指示を毎回入力: 500トークン × 10回 = 5,000トークン
└── 作業実行: 10,000トークン × 10回 = 100,000トークン
合計: 105,000トークン

サブエージェント:
├── 初回定義: 3,000トークン（1回のみ）
├── 起動コスト: 5,000トークン × 10回 = 50,000トークン
└── 作業実行: 10,000トークン × 10回 = 100,000トークン
合計: 153,000トークン

→ 作業自体のトークン消費が支配的になる
→ 指示の明確さによる精度向上が主なメリット
```

## トークン消費を抑える実践的なアドバイス

### 1. 並列実行は計画的に

```
❌ 避けるべき: 大量の並列実行
3つ以上のサブエージェントを同時実行
→ トークン消費速度が3倍以上に

✅ 推奨: 段階的な実行
重要なタスクのみ並列実行
残りは順序実行
→ トークン消費速度を制御
```

### 2. サブエージェントの適切な粒度

```
❌ 避けるべき: 過度に細かい分割
小さなタスクごとに別のサブエージェント
→ 起動コストが累積

✅ 推奨: 適切な粒度
関連するタスクをまとめて1つのサブエージェント
→ 起動コストを最小化
```

### 3. トークン残量の確認

```bash
# トークン使用量の確認
npx ccusage@latest

# 出力例:
# Today: 234,567 tokens used
# Last 5 hours: 189,234 tokens
```

## Max planの利点

Max planでは5時間制限が大幅に緩和されます。

### Proプラン vs Maxプラン

| 項目 | Proプラン | Maxプラン |
|------|----------|----------|
| **5時間制限** | 比較的厳しい | 大幅に緩和 |
| **並列実行** | 慎重に使用 | 積極的に使用可能 |
| **大規模タスク** | 分割が必要 | まとめて実行可能 |
| **推奨使用方法** | 段階的実行 | 並列実行活用 |

### Maxプランでの活用例

```
Maxプランなら可能:
├── 3つのサブエージェントで並列レビュー
├── 5つのサブエージェントでモジュール別実装
└── 大規模リファクタリングをまとめて実行

Proプランでの推奨:
├── 1-2つのサブエージェントで重要タスクのみ並列
├── 残りは順序実行
└── 大規模タスクは日をまたいで分割
```

## まとめ

### 重要なポイント

1. **共有予算**: サブエージェントとメインセッションは同じトークンプールを使用
2. **並列実行のコスト**: 速度は上がるが、トークン消費速度も上がる
3. **長期的効率**: 繰り返し使用する場合に真価を発揮
4. **計画的使用**: トークン予算を意識した戦略的な活用が重要

### 実践的な判断基準

```
サブエージェントを使うべき場合:
✅ 同じタスクを繰り返し実行する
✅ 専門的な知識が必要なタスク
✅ コンテキスト分離が重要なタスク
✅ 長期的なプロジェクト

サブエージェントを使わない方が良い場合:
❌ 1回限りの簡単なタスク
❌ すでにコンテキストに十分な情報がある
❌ トークン予算が残り少ない
❌ 起動コストが作業コストを上回る
```

### 次章の内容

次の章では、サブエージェントの具体的な作成方法を解説します。ファイル構造、frontmatterの書き方、プロンプト設計のベストプラクティスを学びます。
