# サブエージェントの概念

## はじめに

Claude Codeのサブエージェント（Sub agents）機能は、開発効率を飛躍的に向上させる強力な仕組みです。この章では、サブエージェントとは何か、なぜ必要なのか、どのような仕組みで動作するのかを詳しく解説します。

## サブエージェントとは何か

### 定義

**サブエージェント**とは、特定のタスク領域に特化した、独立したシステムプロンプトを持つAIアシスタントです。メインのClaude Codeセッションとは別のコンテキストウィンドウで動作し、専門的なタスクに集中して取り組むことができます。

### 公式の説明

Anthropic公式ドキュメントでは、サブエージェントを次のように定義しています：

> **サブエージェントとは何ですか？**
>
> サブエージェントとは、Claude Codeがタスクを委譲できる事前設定されたAIペルソナのことです。各サブエージェントには以下の特徴があります：
>
> - 特定の目的と専門分野を持っている
> - メインの会話とは別の独自のコンテキストウィンドウを使用する
> - 使用を許可された特定のツールで設定できる
> - その動作を導くカスタムシステムプロンプトが含まれている
>
> Claude Codeがサブエージェントの専門分野に一致するタスクに遭遇すると、その専門化されたサブエージェントにタスクを委譲することができます。サブエージェントは独立して作業し、結果を返します。

### なぜ「専門家」なのか

サブエージェントは言うなれば、「チーム内の専門家」です。メインのClaude Codeは「プロジェクトマネージャー」のような役割を果たし、必要に応じて専門家（サブエージェント）にタスクを委任します。

- **コードレビューアー**: コード品質とセキュリティの専門家
- **デバッガー**: エラー調査とテスト失敗分析の専門家
- **ドキュメントライター**: 技術文書作成の専門家
- **セキュリティ監査官**: 脆弱性検査の専門家

## サブエージェントの構成要素

サブエージェントは以下の4つの要素で構成されます：

### 1. 独立したシステムプロンプト

サブエージェント専用の指示セットです。役割、責務、アプローチ方法などが定義されています。

```markdown
あなたはシニアコードレビューアーです。

責務：
1. コード品質の確認
2. セキュリティの脆弱性検出
3. パフォーマンスの問題認識
4. 保守性の評価
```

### 2. 独立したコンテキストウィンドウ

各サブエージェントは**200,000トークンの独立したコンテキスト窓**を持っています。これはメインセッションの履歴とは完全に分離されています。

```
メインセッション
├─ 過去の会話履歴: 50,000トークン
└─ 現在のタスク: 10,000トークン

サブエージェント（独立）
├─ 専用プロンプト: 3,000トークン
└─ 割り当てられたタスク: 5,000トークン
```

### 3. カスタマイズされたツール権限

必要最小限のツールのみに権限を制限することで、セキュリティと効率を向上させます。

```yaml
# 読み取り専門エージェント
tools: Read, Grep, Glob

# 実装権限を持つエージェント
tools: Read, Write, Edit, Bash

# テスト実行専門
tools: Bash, Read
```

### 4. 特定の専門領域への最適化

各サブエージェントは、特定の領域に特化した知識とアプローチを持ちます。

## サブエージェントの配置場所

サブエージェントはMarkdownファイルとして定義され、決まった場所に配置します。

### ファイル構造

```
.claude/
├── agents/                    # サブエージェント定義フォルダ
│   ├── code-reviewer.md      # コードレビュー専門家
│   ├── debugger.md           # デバッグ専門家
│   ├── test-runner.md        # テスト実行専門家
│   └── doc-writer.md         # ドキュメント作成専門家
├── CLAUDE.md                  # メイン設定ファイル
└── settings.json              # プロジェクト設定
```

### 配置場所の種類

| 配置場所 | パス | スコープ | 用途 |
|---------|------|---------|------|
| **プロジェクト専用** | `.claude/agents/` | 単一プロジェクト | プロジェクト固有の専門家 |
| **個人用（全プロジェクト共通）** | `~/.claude/agents/` | すべてのプロジェクト | 汎用的な専門家 |

## サブエージェントファイルの基本構造

サブエージェントファイルは、以下の構造で定義します。

### 基本テンプレート

```markdown
---
name: code-reviewer
description: コード品質とセキュリティのレビューに特化
tools: Read, Grep, Glob, Bash
model: inherit
---

あなたはシニアコードレビューアーです。

## 責務

1. コード品質の確認
2. セキュリティの脆弱性検出
3. パフォーマンスの問題認識
4. 保守性の評価

## チェックリスト

- [ ] 型安全性の確認
- [ ] エラーハンドリング
- [ ] テストカバレッジ
- [ ] ドキュメント完全性

## レビュープロセス

1. コード全体の構造を把握
2. 各ファイルを詳細にレビュー
3. 問題点をカテゴリ別に整理
4. 改善提案を優先順位付けして提示
```

### frontmatterの要素

```yaml
---
name: エージェント名（英数字、ハイフン、アンダースコアのみ）
description: いつ使用するかの説明（Claude Codeが判断に使用）
tools: 使用を許可するツールのリスト
model: inherit（メインと同じモデルを使用）
---
```

## サブエージェントのメリット

### 1. コンテキストの分離

メインセッションのコンテキストが肥大化すると、精度が低下します。サブエージェントを使うことで、タスクごとに新鮮なコンテキストで作業できます。

**メインセッションのみ（問題あり）:**
```
コンテキストサイズ: 150,000トークン
├─ 過去の実装履歴: 80,000トークン
├─ 現在のタスク: 30,000トークン
├─ レビュー指示: 20,000トークン
└─ その他: 20,000トークン

→ アテンションが分散
→ レビュー精度が低下
```

**サブエージェント使用（改善）:**
```
メインセッション: 80,000トークン
└─ 実装作業に集中

レビューエージェント（独立）: 30,000トークン
├─ レビュープロンプト: 5,000トークン
└─ 対象コード: 25,000トークン

→ レビューに集中
→ 高精度な分析
```

### 2. 役割の明確化

各サブエージェントは明確な役割を持つため、責務が明確になります。

- **実装エージェント**: コードの実装に専念
- **レビューエージェント**: コード品質の評価に専念
- **テストエージェント**: テストの作成と実行に専念

### 3. 再利用性

一度定義したサブエージェントは、何度でも再利用できます。

```markdown
# 初回
> code-reviewerを使用してこのPRをレビューしてください

# 2回目
> code-reviewerを使用してこの実装をレビューしてください

# 3回目（自動）
> このコードをレビューしてください
  （Claude Codeが自動でcode-reviewerを選択）
```

### 4. トークン効率の向上（長期的）

同じ指示を毎回与える代わりに、サブエージェントに役割を定義しておけば、メインセッションのトークン消費を抑えられます。

## 従来の方法との比較

### 従来の方法：手動でファイルを依頼

```
あなた: 「docs/review-guide.mdの指示に従ってレビューしてください」
↓
メインセッションのコンテキストに指示ファイルが読み込まれる
↓
指示ファイル + 過去の会話履歴 + 新作業
↓
すべてが同じコンテキスト空間に蓄積
↓
結果: アテンション拡散により精度低下
```

### サブエージェント使用

```
あなた: 「code-reviewerを使用してレビューしてください」
↓
独立した実行環境が起動
↓
サブエージェント独自のシステムプロンプト + タスク
↓
メインセッション履歴は一切見ない
↓
結果のみがメインセッションに返却
↓
結果: コンテキスト分離により精度向上
```

## サブエージェントが解決する問題

### 問題1: コンテキスト枯渇

長時間のセッションでコンテキストが枯渇し、auto-compactが走ると、直前の作業情報が失われます。

**解決策**: サブエージェントは独立したコンテキストを持つため、メインセッションのコンテキスト枯渇の影響を受けません。

### 問題2: 指示の混乱

複数の役割を1つのセッションで処理すると、指示が混ざり合い、精度が低下します。

**解決策**: 役割ごとにサブエージェントを定義することで、指示が明確になります。

### 問題3: 繰り返しの手間

同じ指示を毎回与える必要がある。

**解決策**: サブエージェントに役割を定義しておけば、名前を指定するだけで済みます。

## まとめ

サブエージェントは、Claude Codeの開発効率を大きく向上させる機能です。

### 重要なポイント

1. **独立性**: メインセッションとは完全に独立したコンテキスト
2. **専門性**: 特定の領域に特化した知識とアプローチ
3. **再利用性**: 一度定義すれば何度でも使える
4. **効率性**: コンテキスト分離により精度向上、長期的なトークン節約

### 次章の内容

次の章では、サブエージェントのトークン消費メカニズムについて、よくある誤解を解消しながら詳しく解説します。トークン予算の仕組みを正しく理解することは、サブエージェントを効果的に活用する上で非常に重要です。
